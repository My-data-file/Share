<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC System</title>

<style>
/* ======================== Variabel Warna & Radius ======================== */
:root{
  --bg:#f4f7fb; 
  --card:#ffffff; 
  --accent:#0ea5a4; 
  --accent-2:#0369a1;
  --muted:#6b7280; 
  --danger:#dc2626; 
  --success:#16a34a; 
  --warning:#facc15;
  --radius:12px;
}

/* ======================== Reset & Body ======================== */
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:var(--bg);
  color:#111;
  min-height:100vh;
  width:100%;
  overflow-x:hidden;
}

/* ======================== Header ======================== */
header{
  background:var(--accent);
  color:#fff;
  padding:1rem 1.5rem;
  font-size:1.4rem;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  position:sticky;
  top:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

#headerTitle {
  font-size: 1.2rem;
  font-weight: bold;
  text-transform: uppercase; /* Hanya judul kapital */
  text-align: center;
}

#headerTime {
  font-size: 0.85rem; /* lebih kecil */
  font-weight: normal;
  text-transform: none; /* Tetap normal */
  text-align: center;
  margin-top: 2px;
}

/* ======================== Layout Container & Nav ======================== */
.container{
  display:flex;
  flex-direction:row;
  width:100%;
  min-height:100vh;
}

nav{
  width:220px;
  background:#fff;
  border-right:1px solid #e5e7eb;
  padding:1rem;
  box-shadow:2px 0 6px rgba(0,0,0,0.05);
  flex-shrink:0;
}

nav button{
  display:block;
  width:100%;
  padding:.8rem 1rem;
  margin-bottom:.6rem;
  border:none;
  border-radius:var(--radius);
  background:var(--accent);
  color:#fff;
  font-weight:500;
  cursor:pointer;
  transition:all .2s ease;
}
nav button:hover{
  background:var(--accent-2);
  transform:translateY(-1px);
}
nav button.active{
  background:var(--accent-2);
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}

/* ======================== Main & Card ======================== */
main{
  flex:1;
  padding:1.5rem;
  display:grid;
  gap:1rem;
}

.card{
  background:var(--card);
  padding:1.2rem;
  border-radius:var(--radius);
  box-shadow:0 2px 8px rgba(0,0,0,.06);
}

/* ======================== Tabs ======================== */
.tabs{
  display:flex;
  gap:.5rem;
  margin-bottom:.75rem;
  flex-wrap:wrap;
}

.tabs button{
  flex:1;
  padding:.6rem;
  border:none;
  border-radius:var(--radius);
  background:#e5e7eb;
  cursor:pointer;
  font-weight:500;
  transition:.2s;
}
.tabs button.active{
  background:var(--accent);
  color:#fff;
}

.tab-content{display:none;}
.tab-content.active{display:block;}

/* ======================== Form Input ======================== */
input[type=text], input[type=number], select{
  padding:.5rem .7rem;
  border:1px solid #ccc;
  border-radius:8px;
  margin-bottom:6px;
  width:100%;
  transition:border .2s, box-shadow .2s;
}

/* ======================== Grid ======================== */
.grid-container{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:0.8rem;
}

.grid-card{
  background:#fff;
  padding:.8rem;
  border-radius:var(--radius);
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  display:flex;
  flex-direction:column;
  gap:6px;
  position:relative;
}

.grid-card input{
  padding:.4rem .6px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-bottom:4px;
  width:100%;
}

/* ======================== Tombol Aksi di Grid ======================== */
.grid-card .btn-icon{
  border:none;
  cursor:pointer;
  border-radius:6px;
  padding:4px 6px;
  font-size:0.9rem;
  transition:.2s;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.btn-call{background:var(--accent);color:#fff;}
.btn-edit{background:#facc15;color:#111;}
.btn-delete{background:var(--danger);color:#fff;}
.btn-save{background:var(--success);color:#fff;}
.btn-icon:hover{opacity:.9;transform:translateY(-1px);}

/* ======================== Edit Inline ======================== */
.edit-grid{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.edit-grid input, .edit-grid select{
  flex:1 1 48%;
  min-width:100px;
}

/* ======================== Status ======================== */
.status-proses{
  background:var(--warning);
  color:#111;
  padding:2px 6px;
  border-radius:6px;
  font-weight:600;
}
.status-selesai{
  background:var(--success);
  color:#fff;
  padding:2px 6px;
  border-radius:6px;
  font-weight:600;
}

.form-group { margin-bottom: 10px; }

/* ======================== Dashboard Finishing Compact Fix ======================== */
#dashboardFinishingProses,
#dashboardFinishingSelesai {
  display: grid; /* HAPUS !important agar JS bisa kontrol show/hide */
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)) !important;
  gap: 6px !important;
  justify-content: start;
  align-items: start;
  width: 100%;
  box-sizing: border-box;
}

#dashboardFinishingProses .grid-card,
#dashboardFinishingSelesai .grid-card {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 6px;
  font-size: 0.7rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  text-align: left;
  line-height: 1.2;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

#dashboardFinishingProses .grid-card:hover,
#dashboardFinishingSelesai .grid-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#dashboardFinishingProses .status-proses,
#dashboardFinishingSelesai .status-selesai {
  font-size: 0.65rem;
  display: inline-block;
  padding: 1px 4px;
  border-radius: 4px;
  margin-top: 2px;
}

/* Judul mini di dashboard */
#dashboard h4 {
  font-size: 0.8rem;
  margin-bottom: 4px;
}

/* ======================== Responsif ======================== */
@media(max-width:768px){
  .container{flex-direction:column;}
  nav{
    width:100%;
    display:flex;
    overflow-x:auto;
    padding:.5rem;
  }
  nav button{
    flex:1;
    min-width:120px;
    margin:0 4px 0 0;
  }
  main{padding:1rem;}
}

</style>
</head>
<body>

<!-- ======================== Header ======================== -->
<header>
  <div id="headerTitle">üìä Sistem QC</div>
  <div id="headerTime">Selasa, 5 Oktober 2025 14:30</div>
</header>

<!-- ======================== Container ======================== -->
<div class="container">

  <!-- ======================== Menu Nav ======================== -->
  <nav>
    <button onclick="showMenu('dashboard')" class="active">DASBOARD</button>
    <button onclick="showMenu('qcBapro')">QC BAPRO</button>
    <button onclick="showMenu('qcPA')">QC PA</button>
    <button onclick="showMenu('qcFinishing')">QC FINISHING</button>
    <button onclick="showMenu('qcLem')">QC LEM</button>
  </nav>

  <!-- ======================== Main Section ======================== -->
  <main>

    <!-- ======================== Dashboard ======================== -->
    <section id="dashboard" class="card qc-section">

<!-- ======================== QC Bapro ======================== -->
<h2 style="text-align:center; color:#fff; background:#1E90FF; padding:6px 12px; border-radius:8px; margin-bottom:12px;">
  Dashboard QC Bapro
</h2>

      <!-- Info Total -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; justify-content:center;">
        <div style="flex:1; min-width:120px; background:#e5f6f6; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Order<br><strong id="countBapro">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#fff4e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Proses<br><strong id="countProsesBapro">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#e5f7e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Selesai<br><strong id="countSelesaiBapro">0</strong>
        </div>
      </div>

      <!-- Grid Proses -->
      <div style="text-align:center; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Proses</h4>
        <button id="toggleProsesBapro" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardBaproProses" class="grid-container" style="display:none;"></div>

      <!-- Grid Selesai -->
      <div style="text-align:center; margin-top:12px; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Selesai</h4>
        <button id="toggleSelesaiBapro" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardBaproSelesai" class="grid-container" style="display:none;"></div>

    <!-- ======================== QC PA ======================== -->
<h2 style="text-align:center; color:#fff; background:#1E90FF; padding:6px 12px; border-radius:8px; margin-bottom:12px;">
  Dashboard QC PA
</h2>

      <!-- Info Total -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; justify-content:center;">
        <div style="flex:1; min-width:120px; background:#e5f6f6; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Order<br><strong id="countPA">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#fff4e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Proses<br><strong id="countProsesPA">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#e5f7e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Selesai<br><strong id="countSelesaiPA">0</strong>
        </div>
      </div>

      <!-- Grid Proses -->
      <div style="text-align:center; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Proses</h4>
        <button id="toggleProsesPA" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardPAProses" class="grid-container" style="display:none;"></div>

      <!-- Grid Selesai -->
      <div style="text-align:center; margin-top:12px; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Selesai</h4>
        <button id="toggleSelesaiPA" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardPASelesai" class="grid-container" style="display:none;"></div>

    <!-- ======================== QC Finishing ======================== -->
<h2 style="text-align:center; color:#fff; background:#1E90FF; padding:6px 12px; border-radius:8px; margin-bottom:12px;">
  Dashboard QC Finishing
</h2>

      <!-- Info Total -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; justify-content:center;">
        <div style="flex:1; min-width:120px; background:#e5f6f6; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Order<br><strong id="countFinishing">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#fff4e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Proses<br><strong id="countProses">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#e5f7e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Selesai<br><strong id="countSelesai">0</strong>
        </div>
      </div>

      <!-- Grid Proses -->
      <div style="text-align:center; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Proses</h4>
        <button id="toggleProses" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardFinishingProses" class="grid-container" style="display:none;"></div>

      <!-- Grid Selesai -->
      <div style="text-align:center; margin-top:12px; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Selesai</h4>
        <button id="toggleSelesai" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardFinishingSelesai" class="grid-container" style="display:none;"></div>

    <!-- ======================== QC Lem ======================== -->
<h2 style="text-align:center; color:#fff; background:#1E90FF; padding:6px 12px; border-radius:8px; margin-bottom:12px;">
  Dashboard QC Lem
</h2>

      <!-- Info Total -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; justify-content:center;">
        <div style="flex:1; min-width:120px; background:#e5f6f6; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Order<br><strong id="countLem">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#fff4e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Proses<br><strong id="countProsesLem">0</strong>
        </div>
        <div style="flex:1; min-width:120px; background:#e5f7e5; padding:6px 10px; border-radius:8px; text-align:center;">
          Total Selesai<br><strong id="countSelesaiLem">0</strong>
        </div>
      </div>

      <!-- Grid Proses -->
      <div style="text-align:center; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Proses</h4>
        <button id="toggleProsesLem" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardLemProses" class="grid-container" style="display:none;"></div>

      <!-- Grid Selesai -->
      <div style="text-align:center; margin-top:12px; margin-bottom:4px;">
        <h4 style="display:inline-block; margin:0;">Selesai</h4>
        <button id="toggleSelesaiLem" style="margin-left:8px; padding:2px 6px;font-size:0.8rem;">Show</button>
      </div>
      <div id="dashboardLemSelesai" class="grid-container" style="display:none;"></div>

    </section>

<!-- ======================== QC BAPRO ======================== -->
<section id="qcBapro" class="card qc-section" style="display:none;">

  <div class="tabs">
    <button class="active" data-tab="inputBapro" onclick="switchTab(this)">Inputan</button>
    <button data-tab="hasilBapro" onclick="switchTab(this)">Hasil</button>
  </div>

  <div id="inputBapro" class="tab-content active">
    <div class="form-group"><input type="text" id="baproNama" placeholder="Nama Order"></div>
    <div class="form-group"><input type="text" id="baproNoKS" placeholder="No KS"></div>
    <div class="form-group"><input type="number" id="baproOrder" placeholder="Total Order (lembar)"></div>
    <div class="form-group"><input type="number" id="baproIsi" placeholder="Isi/Dus (pcs)"></div>
    <div class="form-group"><input type="number" id="baproBagus" placeholder="Total Bagus (pcs)"></div>
    <div class="form-group"><input type="number" id="baproJenisBS" placeholder="Total BS (pcs)"></div>
    <div class="form-group">
      <select id="baproQC">
        <option value="">QC</option>
        <option value="Anom">Anom</option>
        <option value="Irna">Irna</option>
      </select>
    </div>
    <div class="form-group">
      <select id="baproUpdate">
        <option value="">Update</option>
        <option value="Proses">Proses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="form-group">
      <textarea id="baproKeterangan" placeholder="Keterangan (opsional)" rows="3" style="width:100%; padding:.6rem; border:1px solid #ccc; border-radius:8px;"></textarea>
    </div>
    <div class="form-group"><button onclick="addBaproItem()">‚ûï Tambah</button></div>
  </div>

  <div id="hasilBapro" class="tab-content">
    <input type="text" placeholder="Cari..." oninput="filterBaproGrid(this.value)">
    <div id="gridBapro" class="grid-container"></div>
  </div>
</section>

<!-- ======================== QC PA ======================== -->
<section id="qcPA" class="card qc-section" style="display:none;">

  <div class="tabs">
    <button class="active" data-tab="inputPA" onclick="switchTab(this)">Inputan</button>
    <button data-tab="hasilPA" onclick="switchTab(this)">Hasil</button>
  </div>

  <div id="inputPA" class="tab-content active">
    <div class="form-group"><input type="text" id="paNama" placeholder="Nama Order"></div>
    <div class="form-group"><input type="text" id="paNoKS" placeholder="No KS"></div>
    <div class="form-group"><input type="number" id="paOrder" placeholder="Total Order (lembar)"></div>
    <div class="form-group"><input type="number" id="paIsi" placeholder="Isi/Dus (pcs)"></div>
    <div class="form-group"><input type="number" id="paBagus" placeholder="Total Bagus (pcs)"></div>
    <div class="form-group"><input type="number" id="paJenisBS" placeholder="Total BS (pcs)"></div>
    <div class="form-group">
      <select id="paQC">
        <option value="">QC</option>
        <option value="Anom">Anom</option>
        <option value="Irna">Irna</option>
      </select>
    </div>
    <div class="form-group">
      <select id="paUpdate">
        <option value="">Update</option>
        <option value="Proses">Proses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="form-group">
      <textarea id="paKeterangan" placeholder="Keterangan (opsional)" rows="3" style="width:100%; padding:.6rem; border:1px solid #ccc; border-radius:8px;"></textarea>
    </div>
    <div class="form-group"><button onclick="addPAItem()">‚ûï Tambah</button></div>
  </div>

  <div id="hasilPA" class="tab-content">
    <input type="text" placeholder="Cari..." oninput="filterPAGrid(this.value)">
    <div id="gridPA" class="grid-container"></div>
  </div>
</section>

<!-- ======================== QC FINISHING ======================== -->
<section id="qcFinishing" class="card qc-section" style="display:none;">

  <div class="tabs">
    <button class="active" data-tab="inputFinishing" onclick="switchTab(this)">Inputan</button>
    <button data-tab="hasilFinishing" onclick="switchTab(this)">Hasil</button>
  </div>

  <div id="inputFinishing" class="tab-content active">
    <div class="form-group"><input type="text" id="finishingNama" placeholder="Nama Order"></div>
    <div class="form-group"><input type="text" id="finishingNoKS" placeholder="No KS"></div>
    <div class="form-group"><input type="number" id="finishingOrder" placeholder="Total Order (lembar)"></div>
    <div class="form-group"><input type="number" id="finishingIsi" placeholder="Isi/Dus (pcs)"></div>
    <div class="form-group"><input type="number" id="finishingBagus" placeholder="Total Bagus (pcs)"></div>
    <div class="form-group"><input type="number" id="finishingJenisBS" placeholder="Total BS (pcs)"></div>
    <div class="form-group">
      <select id="finishingQC">
        <option value="">QC</option>
        <option value="Anom">Anom</option>
        <option value="Irna">Irna</option>
      </select>
    </div>
    <div class="form-group">
      <select id="finishingUpdate">
        <option value="">Update</option>
        <option value="Proses">Proses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="form-group">
      <textarea id="finishingKeterangan" placeholder="Keterangan (opsional)" rows="3" style="width:100%; padding:.6rem; border:1px solid #ccc; border-radius:8px;"></textarea>
    </div>
    <div class="form-group"><button onclick="addFinishingItem()">‚ûï Tambah</button></div>
  </div>

  <div id="hasilFinishing" class="tab-content">
    <input type="text" placeholder="Cari..." oninput="filterFinishingGrid(this.value)">
    <div id="gridFinishing" class="grid-container"></div>
  </div>
</section>

<!-- ======================== QC LEM ======================== -->
<section id="qcLem" class="card qc-section" style="display:none;">

  <div class="tabs">
    <button class="active" data-tab="inputLem" onclick="switchTab(this)">Inputan</button>
    <button data-tab="hasilLem" onclick="switchTab(this)">Hasil</button>
  </div>

  <div id="inputLem" class="tab-content active">
    <div class="form-group"><input type="text" id="lemNama" placeholder="Nama Order"></div>
    <div class="form-group"><input type="text" id="lemNoKS" placeholder="No KS"></div>
    <div class="form-group"><input type="number" id="lemOrder" placeholder="Total Order (lembar)"></div>
    <div class="form-group"><input type="number" id="lemIsi" placeholder="Isi/Dus (pcs)"></div>
    <div class="form-group"><input type="number" id="lemBagus" placeholder="Total Bagus (pcs)"></div>
    <div class="form-group"><input type="number" id="lemJenisBS" placeholder="Total BS (pcs)"></div>
    <div class="form-group">
      <select id="lemQC">
        <option value="">QC</option>
        <option value="Anom">Anom</option>
        <option value="Irna">Irna</option>
      </select>
    </div>
    <div class="form-group">
      <select id="lemUpdate">
        <option value="">Update</option>
        <option value="Proses">Proses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="form-group">
      <textarea id="lemKeterangan" placeholder="Keterangan (opsional)" rows="3" style="width:100%; padding:.6rem; border:1px solid #ccc; border-radius:8px;"></textarea>
    </div>
    <div class="form-group"><button onclick="addLemItem()">‚ûï Tambah</button></div>
  </div>

  <div id="hasilLem" class="tab-content">
    <input type="text" placeholder="Cari..." oninput="filterLemGrid(this.value)">
    <div id="gridLem" class="grid-container"></div>
  </div>
</section>

  </main>
</div>

<script>
// ====================== KONFIGURASI ======================
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzbu9ZUzOez5EorkQ68ruP9ERpzGWxTT6gc9t7_oUhVoIYGEg68qLqD47DQh9YMSPAf/exec";

// ====================== WAKTU HEADER ======================
function updateTime(){
  document.getElementById('headerTime').textContent =
    new Date().toLocaleString('id-ID',{weekday:'long',day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateTime,1000); updateTime();

// ====================== MENU ======================
function showMenu(menu) {
  document.querySelectorAll('main > section').forEach(sec => sec.style.display = 'none');
  document.getElementById(menu).style.display = 'block';
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`nav button[onclick="showMenu('${menu}')"]`).classList.add('active');

  if (menu === 'dashboard') renderDashboardFinishingCompact();
}

// ====================== TABS ======================
function switchTab(btn) {
  const parent = btn.parentElement;
  parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  parent.parentElement.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(btn.dataset.tab).classList.add('active');

  if (btn.dataset.tab === 'hasilFinishing') {
    loadFinishingItems(); // refresh saat buka tab hasil
  }
}

// ====================== JSONP HELPER ======================
function jsonpGet(url, params = {}) {
  return new Promise((resolve, reject) => {
    const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2, 9);
    params = params || {};
    params.callback = cbName;
    const q = Object.entries(params).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
    const script = document.createElement('script');
    script.src = `${url}?${q}`;
    script.onerror = () => {
      cleanup();
      reject(new Error('JSONP load error'));
    };
    window[cbName] = (res) => {
      cleanup();
      resolve(res);
    };
    function cleanup(){
      delete window[cbName];
      script.remove();
    }
    document.body.appendChild(script);
  });
}

// ====================== GLOBAL STATE ======================
let finishingItems = []; // array yang diambil dari sheet

// ====================== RENDER GRID HASIL ======================
function renderGridFinishing(query = "") {
  const container = document.getElementById('gridFinishing');
  container.innerHTML = '';

  const q = (query||'').toLowerCase();

  finishingItems.forEach((item, i) => {
    if (q && !(String(item.nama||'').toLowerCase().includes(q) || String(item.noKS||'').toLowerCase().includes(q))) return;

    const card = document.createElement('div');
    card.className = 'grid-card';

    const statusClass = item.update === "Proses" ? "status-proses" : (item.update === "Selesai" ? "status-selesai" : "");
    const tanggal = item.tanggal ? `<strong>${escapeHtml(item.tanggal)}</strong><br>` : '';

    card.innerHTML = `
      <div>
        ${tanggal}
        <span>Nama Order: ${escapeHtml(item.nama||'')}</span><br>
        <span>No KS: ${escapeHtml(item.noKS||'')}</span><br>
        <span>Order: ${escapeHtml(item.order||'')}</span><br>
        <span>Isi/Dus: ${escapeHtml(item.isi||'')}</span><br>
        <span>Bagus: ${escapeHtml(item.bagus||'')}</span><br>
        <span>BS: ${escapeHtml(item.jenisBS||'')}</span><br>
        <span>QC: ${escapeHtml(item.qc||'')}</span><br>
        <span>Keterangan: ${escapeHtml(item.keterangan||'')}</span><br>
        <span class="${statusClass}">${escapeHtml(item.update||'')}</span>
      </div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px;">
        <button class="btn-icon btn-call" title="Panggil" onclick="callFinishing(${i})">üì§</button>
        <button class="btn-icon btn-edit" title="Edit Inline" onclick="editFinishingInline(${i})">‚úèÔ∏è</button>
        <button class="btn-icon btn-delete" title="Hapus" onclick="deleteFinishing(${i})">üóëÔ∏è</button>
      </div>`;

    container.appendChild(card);
  });

  renderDashboardFinishingCompact();
}

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ====================== LOAD DATA DARI SPREADSHEET ======================
async function loadFinishingItems(){
  try{
    const res = await jsonpGet(WEBAPP_URL, { action: 'get', sheet: 'Finishing' });
    if(res && res.status === 'ok' && Array.isArray(res.data)){
      finishingItems = res.data.map((it, idx) => ({ __index: idx, id: (it.id||it._row||it.row||null), ...it }));
      renderGridFinishing();
    } else console.warn('loadFinishingItems unexpected', res);
  }catch(err){ console.error('‚ö†Ô∏è Error loadFinishingItems', err); }
}

// ====================== TAMBAH DATA ======================
function addFinishingItem() {
  const nama = document.getElementById('finishingNama').value.trim();
  const noKS = document.getElementById('finishingNoKS').value.trim();
  const order = document.getElementById('finishingOrder').value.trim();
  const isi = document.getElementById('finishingIsi').value.trim();
  const bagus = document.getElementById('finishingBagus').value.trim();
  const jenisBS = document.getElementById('finishingJenisBS').value.trim();
  const qc = document.getElementById('finishingQC').value.trim();
  const update = document.getElementById('finishingUpdate').value.trim();
  const keterangan = document.getElementById('finishingKeterangan').value.trim(); // ‚ú≥Ô∏è tambahan baru

  if (!nama || !noKS) return alert('Nama dan No KS wajib diisi!');

  const tanggalFormatted = new Date().toLocaleString('id-ID', {
    day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'
  });

  const payload = { action:'add', sheet:'Finishing', tanggal: tanggalFormatted, nama,noKS,order,isi,bagus,jenisBS,qc,update,keterangan };

  postPayload(payload);
  clearFinishingForm();
  setTimeout(() => loadFinishingItems(), 20000);
}

// ====================== PANGGIL (isi form dari item) ======================
function callFinishing(index){
  const item = finishingItems[index];
  if(!item) return;
  document.getElementById('finishingNama').value = item.nama || '';
  document.getElementById('finishingNoKS').value = item.noKS || '';
  document.getElementById('finishingOrder').value = item.order || '';
  document.getElementById('finishingIsi').value = item.isi || '';
  document.getElementById('finishingBagus').value = item.bagus || '';
  document.getElementById('finishingJenisBS').value = item.jenisBS || '';
  document.getElementById('finishingQC').value = item.qc || '';
  document.getElementById('finishingUpdate').value = item.update || '';
  document.getElementById('finishingKeterangan').value = item.keterangan || ''; // ‚ú≥Ô∏è tambahan

  showMenu('qcFinishing');
  const tabBtn = document.querySelector('#qcFinishing .tabs button[data-tab="inputFinishing"]');
  if(tabBtn) switchTab(tabBtn);
}

// ====================== HAPUS ITEM ======================
function deleteFinishing(index){
  const item = finishingItems[index];
  if(!item) return;
  if(!confirm('Hapus data ini?')) return;

  const container = document.getElementById('gridFinishing');
  const card = container.children[index];
  const btnDelete = card?.querySelector('.btn-delete');

  if (btnDelete) {
    btnDelete.textContent = '‚è≥ Menghapus...';
    btnDelete.disabled = true;
  }

  const identifier = item.id || item._row || item.row || item.__index;
  const payload = { action:'delete', sheet:'Finishing', id: identifier, index: item.__index };
  postPayload(payload);

  // tampilkan status dan reload otomatis
  setTimeout(() => {
    if (btnDelete) {
      btnDelete.textContent = 'üóëÔ∏è';
      btnDelete.disabled = false;
    }
    loadFinishingItems();
  }, 20000); // tunggu update sheet
}

// ====================== EDIT INLINE ======================
function editFinishingInline(index){
  const item = finishingItems[index];
  const container = document.getElementById('gridFinishing');
  const card = container.children[index];
  if(!card) return;
  if(card.querySelector('.edit-inline')) return;

  card.innerHTML = `
    <div class="edit-grid">
      <input type="text" class="edit-inline" value="${escapeHtml(item.nama||'')}" placeholder="Nama Order">
      <input type="text" class="edit-inline" value="${escapeHtml(item.noKS||'')}" placeholder="No KS">
      <input type="number" class="edit-inline" value="${escapeHtml(item.order||'')}" placeholder="Order">
      <input type="number" class="edit-inline" value="${escapeHtml(item.isi||'')}" placeholder="Isi/Dus">
      <input type="number" class="edit-inline" value="${escapeHtml(item.bagus||'')}" placeholder="Bagus">
      <input type="number" class="edit-inline" value="${escapeHtml(item.jenisBS||'')}" placeholder="BS">
      <select class="edit-inline">
        <option value="Anom" ${item.qc==='Anom'? 'selected':''}>Anom</option>
        <option value="Irna" ${item.qc==='Irna'? 'selected':''}>Irna</option>
      </select>
      <select class="edit-inline">
        <option value="Proses" ${item.update==='Proses'? 'selected':''}>Proses</option>
        <option value="Selesai" ${item.update==='Selesai'? 'selected':''}>Selesai</option>
      </select>
      <textarea class="edit-inline" rows="2" placeholder="Keterangan">${escapeHtml(item.keterangan||'')}</textarea>
    </div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px;">
      <button class="btn-icon btn-save" title="Simpan" onclick="saveFinishingInline(${index})">üíæ</button>
    </div>`;
}

// ====================== SIMPAN HASIL EDIT INLINE ======================
function saveFinishingInline(index) {
  const container = document.getElementById('gridFinishing');
  const card = container.children[index];
  if (!card) return;
  const btnSave = card.querySelector('.btn-save');
  if (btnSave) {
    btnSave.textContent = '‚è≥ Menyimpan...';
    btnSave.disabled = true;
  }

  const inputs = card.querySelectorAll('.edit-inline');

  const updated = {
    nama: inputs[0].value.trim(),
    noKS: inputs[1].value.trim(),
    order: inputs[2].value.trim(),
    isi: inputs[3].value.trim(),
    bagus: inputs[4].value.trim(),
    jenisBS: inputs[5].value.trim(),
    qc: inputs[6].value,
    update: inputs[7].value,
    keterangan: inputs[8].value.trim()
  };

  const orig = finishingItems[index];
  const identifier = orig.id || orig._row || orig.row || orig.__index;

  const tanggalFormatted = orig.tanggal || new Date().toLocaleString('id-ID', {
    day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'
  });

  const payload = { action:'update', sheet:'Finishing', id: identifier, index: orig.__index, tanggal: tanggalFormatted, ...updated };

  // kirim ke server
  postPayload(payload);

  // tampilkan status ‚Äúmenunggu update spreadsheet‚Äù
  setTimeout(() => {
    if (btnSave) {
      btnSave.textContent = 'üíæ Simpan';
      btnSave.disabled = false;
    }
    loadFinishingItems();
  }, 20000); // waktu refresh setelah update
}

// ====================== POST PAYLOAD ======================
function ensureIframe(){
  if(document.querySelector('iframe[name="hidden_iframe_post"]')) return;
  const ifr = document.createElement('iframe');
  ifr.name = 'hidden_iframe_post';
  ifr.style.display = 'none';
  ifr.addEventListener('load', ()=> setTimeout(()=> loadFinishingItems(), 10000));
  document.body.appendChild(ifr);
}
function postPayload(payloadObj){
  ensureIframe();
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = WEBAPP_URL;
  form.target = 'hidden_iframe_post';
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'payload';
  input.value = JSON.stringify(payloadObj);
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
  form.remove();
}

// ====================== FILTER ======================
function filterFinishingGrid(query){ renderGridFinishing(query); }

// ====================== CLEAR FORM ======================
function clearFinishingForm() {
  ['finishingNama','finishingNoKS','finishingOrder','finishingIsi','finishingBagus','finishingJenisBS','finishingQC','finishingUpdate','finishingKeterangan']
    .forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
}

// ====================== DASHBOARD ======================
function renderDashboardFinishingCompact() {
  const containerProses = document.getElementById('dashboardFinishingProses');
  const containerSelesai = document.getElementById('dashboardFinishingSelesai');
  containerProses.innerHTML = ''; containerSelesai.innerHTML = '';

  let totalProses = 0, totalSelesai = 0;

  finishingItems.forEach(item => {
    const updateVal = (item.update || "").trim().toLowerCase();
    const tanggal = item.tanggal ? item.tanggal : "-";
    const card = document.createElement('div');
    card.className = 'grid-card';
    const statusClass = updateVal === "proses" ? "status-proses" :
                        updateVal === "selesai" ? "status-selesai" : "";
    card.innerHTML = `
      <strong>${escapeHtml(item.nama || '')}</strong><br>
      <span>QC: ${escapeHtml(item.qc || '')}</span><br>
      <span>üìÖ ${escapeHtml(tanggal)}</span><br>
      <span class="${statusClass}">${escapeHtml(item.update || '')}</span>`;
    if (updateVal === 'proses'){ containerProses.appendChild(card); totalProses++; }
    else if (updateVal === 'selesai'){ containerSelesai.appendChild(card); totalSelesai++; }
    card.addEventListener('click', () => showDetailModal(item));
  });

  document.getElementById('countFinishing').textContent = finishingItems.length;
  document.getElementById('countProses').textContent = totalProses;
  document.getElementById('countSelesai').textContent = totalSelesai;
}

// ====================== DETAIL ======================
function showDetailModal(item) {
  alert(`Detail Order:
Nama: ${item.nama}
No KS: ${item.noKS}
Order: ${item.order}
Isi: ${item.isi}
Bagus: ${item.bagus}
BS: ${item.jenisBS}
QC: ${item.qc}
Update: ${item.update}
Keterangan: ${item.keterangan || '-'}`);
}

// ====================== TOGGLE VIEW ======================
document.addEventListener('DOMContentLoaded', () => {
  const btnProses = document.getElementById('toggleProses');
  const btnSelesai = document.getElementById('toggleSelesai');
  const gridProses = document.getElementById('dashboardFinishingProses');
  const gridSelesai = document.getElementById('dashboardFinishingSelesai');

  if (btnProses && gridProses) {
    btnProses.addEventListener('click', () => {
      const visible = gridProses.style.display !== 'none';
      gridProses.style.display = visible ? 'none' : 'grid';
      btnProses.textContent = visible ? 'Show' : 'Hide';
    });
  }

  if (btnSelesai && gridSelesai) {
    btnSelesai.addEventListener('click', () => {
      const visible = gridSelesai.style.display !== 'none';
      gridSelesai.style.display = visible ? 'none' : 'grid';
      btnSelesai.textContent = visible ? 'Show' : 'Hide';
    });
  }
});

// ====================== AUTO UPPERCASE ======================
document.addEventListener('input', (e) => {
  if (!e.target) return;
  const el = e.target;

  // Berlaku untuk input text dan textarea di dalam #qcFinishing
  if (
    (el.tagName === 'INPUT' && el.type === 'text' && el.closest('#qcFinishing')) ||
    (el.tagName === 'TEXTAREA' && el.closest('#qcFinishing'))
  ) {
    el.value = el.value.toUpperCase();
  }
});

// ====================== INISIALISASI ======================
showMenu('dashboard');
loadFinishingItems();


</script>

</body>
</html>
