<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sea Laundry Admin</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:0; }
header { background:#1f2937; color:white; padding:15px; text-align:center; }
.container { padding:20px; }

/* Tombol */
button { padding:7px 14px; margin:5px 0; cursor:pointer; border:none; border-radius:5px; background:#2563eb; color:white; font-weight:bold; transition: background 0.2s;}
button:hover { background:#1e40af; }

/* Dashboard */
#dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:15px; margin-bottom:20px; }
.card { padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; background:white; }
.card h3 { font-size:14px; color:#374151; margin:0; }
.card p { font-size:20px; font-weight:bold; margin:5px 0 0; }

/* Notifikasi Order Baru */
#newOrdersBox { padding:12px; margin:10px 0; border:2px solid #2563eb; border-radius:8px; background:#eff6ff; }
#newOrdersBox h3 { margin:0 0 10px 0; color:#1e40af; }

/* Grid Cards */
#ordersGrid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:15px; }
.order-card { background:white; border-radius:12px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:relative; }
.order-card h4 { margin:0 0 8px 0; font-size:16px; color:#1e40af; }
.order-card p { margin:4px 0; font-size:13px; color:#374151; }
.order-card .status { display:inline-block; padding:3px 8px; border-radius:6px; font-size:12px; font-weight:bold; margin-top:6px; }
.status.Dipesan { background:#fef3c7; color:#92400e; }
.status.Dijemput { background:#bfdbfe; color:#1e3a8a; }
.status.Diproses { background:#ddd6fe; color:#5b21b6; }
.status.Selesai { background:#d1fae5; color:#065f46; }
.status.DiantAR { background:#bbf7d0; color:#065f46; }
.order-card button { margin-top:10px; width:100%; }

/* Toast Notifikasi */
.toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 250px; padding: 15px 20px; border-radius: 8px; font-size: 15px; font-weight: bold; text-align: center; display: none; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
.toast.success { background:#16a34a; color:white; }
.toast.error { background:#dc2626; color:white; }

/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; }
.modal-content { background:white; padding:20px; border-radius:12px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; }
.modal-content h3 { margin-top:0; }
.modal-content label { display:block; margin:8px 0 4px; font-size:13px; font-weight:bold; }
.modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:6px; border:1px solid #ccc; border-radius:6px; font-size:13px; }

/* Filter */
.filter-bar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin-bottom:15px; }
.filter-bar input, .filter-bar select { padding:6px; border:1px solid #ccc; border-radius:6px; font-size:13px; }

</style>
</head>
<body>

<header>
  <h1>Admin Panel - Sea Laundry</h1>
</header>

<div class="container">
  <div id="notif" class="toast"></div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="card" style="background:#bfdbfe;">
      <h3>Jumlah Pemesan</h3><p id="totalOrders">0</p>
    </div>
    <div class="card" style="background:#bbf7d0;">
      <h3>Total Berat (Kg)</h3><p id="totalWeight">0 Kg</p>
    </div>
    <div class="card" style="background:#fef08a;">
      <h3>Total Pemasukan</h3><p id="totalIncome">Rp 0</p>
    </div>
    <div class="card" style="background:#ddd6fe;">
      <h3>Order Aktif</h3><p id="activeOrders">0</p>
    </div>
    <div class="card" style="background:#e5e7eb;">
      <h3>Order Selesai</h3><p id="completedOrders">0</p>
    </div>
  </div>

  <!-- Notifikasi Pesanan Baru -->
  <div id="newOrdersBox">
    <h3>üì¢ Pesanan Baru</h3>
    <ul id="newOrdersList" style="list-style:none; padding:0; margin:0;"></ul>
  </div>

  <!-- Filter -->
  <div class="filter-bar">
    <button onclick="confirmRefresh()">üîÑ Refresh Orders</button>
    <input type="text" id="searchInput" placeholder="Cari Nama / Alamat">
    <select id="statusFilter">
      <option value="">Semua Status</option>
      <option value="Dipesan">Dipesan</option>
      <option value="Dijemput">Dijemput</option>
      <option value="Diproses">Diproses</option>
      <option value="Selesai">Selesai</option>
      <option value="Diantar">Diantar</option>
    </select>
  </div>

  <!-- Grid Cards -->
  <div id="ordersGrid"></div>
</div>

<!-- Modal Detail -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <h3>Detail Pesanan</h3>
    <form id="orderForm">
      <input type="hidden" id="rowIndex">
      <label>Nama</label><input type="text" id="Nama">
      <label>Alamat</label><textarea id="Alamat"></textarea>
      <label>No HP</label><input type="text" id="NoHP">
      <label>Layanan</label><input type="text" id="Layanan">
      <label>Catatan</label><textarea id="Catatan"></textarea>
      <label>Jadwal</label><input type="text" id="Jadwal">
      <label>Status</label>
      <select id="Status">
        <option>Dipesan</option>
        <option>Dijemput</option>
        <option>Diproses</option>
        <option>Selesai</option>
        <option>Diantar</option>
      </select>
      <label>Berat (Kg)</label><input type="number" id="Berat">
      <label>Harga (Rp)</label><input type="number" id="Harga">
      <div style="margin-top:15px; text-align:right;">
        <button type="button" onclick="saveOrder()">üíæ Simpan</button>
        <button type="button" onclick="closeModal()">‚ùå Tutup</button>
      </div>
    </form>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwJax3FO_zvxRrsYtL6X_3xsmZAWG9gwxSs-ljpvGvMCR003h0qjf3_rq7wMDn2yv8Z5A/exec";
let currentData = [];
const statusOptions = ["Dipesan","Dijemput","Diproses","Selesai","Diantar"];

let seenOrders = new Set(JSON.parse(localStorage.getItem("seenOrders")||"[]"));
function saveSeenOrders(){ localStorage.setItem("seenOrders",JSON.stringify([...seenOrders])); }

function showNotif(msg,type="success"){
  const notif=document.getElementById("notif");
  notif.textContent=msg;
  notif.className="toast "+(type==="success"?"success":"error");
  notif.style.display="block";
  setTimeout(()=>notif.style.display="none",2000);
}

function confirmRefresh(){ if(confirm("Yakin mau reload data order?")){ loadOrders(); showNotif("üîÑ Data berhasil direfresh"); } }

function loadOrders(){
  fetch(GAS_URL,{method:"POST",body:JSON.stringify({type:"GetAllOrders"})})
  .then(res=>res.json())
  .then(data=>{
    currentData=data.orders||[];
    renderCards(currentData);
    updateDashboard(currentData);
    highlightNewOrders(currentData);
  })
  .catch(err=>{console.error(err);showNotif("‚ö†Ô∏è Gagal load order","error");});
}

function renderCards(data){
  const grid=document.getElementById("ordersGrid");
  grid.innerHTML="";
  if(!data.length){ grid.innerHTML="<p style='text-align:center;'>Tidak ada order</p>"; return; }
  data.forEach(o=>{
    const harga=parseInt(o.Harga||0).toLocaleString("id-ID");
    const berat=o.Berat||0;
    const card=document.createElement("div");
    card.className="order-card";
    card.innerHTML=`
      <h4>${o.Nama||"Tanpa Nama"}</h4>
      <p>üìç ${o.Alamat||"-"}</p>
      <p>üìû ${o["No HP"]||"-"}</p>
      <p>üõ†Ô∏è ${o.Layanan||"-"}</p>
      <p>üìÖ ${o.Jadwal||"-"}</p>
      <span class="status ${o.Status}">${o.Status}</span>
      <p>‚öñÔ∏è ${berat} Kg | üí∞ Rp ${harga}</p>
      <button onclick='openModal(${JSON.stringify(o)})'>Detail / Update</button>
    `;
    grid.appendChild(card);
  });
}

function highlightNewOrders(data){
  const box=document.getElementById("newOrdersBox");
  const list=document.getElementById("newOrdersList");
  list.innerHTML="";
  let pending=data.filter(o=>o.Status==="Dipesan" && !seenOrders.has(String(o.rowIndex)));
  if(pending.length){
    pending.forEach(o=>{
      const li=document.createElement("li");
      li.innerHTML=`<b>${o.Nama||"Tanpa Nama"}</b> - ${o.Layanan||""} <button onclick='openModal(${JSON.stringify(o)})'>Lihat</button>`;
      list.appendChild(li);
    });
  } else {
    list.innerHTML="<li style='font-style:italic;color:#555;'>Tidak ada order baru</li>";
  }
}

function updateDashboard(data){
  let totalOrders=data.length;
  let totalWeight=data.reduce((s,o)=>s+parseFloat(o.Berat||0),0);
  let totalIncome=data.reduce((s,o)=>s+parseFloat(o.Harga||0),0);
  let activeOrders=data.filter(o=>!["Selesai","Diantar"].includes(o.Status)).length;
  let completedOrders=data.filter(o=>["Selesai","Diantar"].includes(o.Status)).length;
  document.getElementById("totalOrders").textContent=totalOrders;
  document.getElementById("totalWeight").textContent=totalWeight.toFixed(2)+" Kg";
  document.getElementById("totalIncome").textContent="Rp "+totalIncome.toLocaleString("id-ID");
  document.getElementById("activeOrders").textContent=activeOrders;
  document.getElementById("completedOrders").textContent=completedOrders;
}

/* Modal */
function openModal(order){
  document.getElementById("rowIndex").value=order.rowIndex;
  document.getElementById("Nama").value=order.Nama||"";
  document.getElementById("Alamat").value=order.Alamat||"";
  document.getElementById("NoHP").value=order["No HP"]||"";
  document.getElementById("Layanan").value=order.Layanan||"";
  document.getElementById("Catatan").value=order.Catatan||"";
  document.getElementById("Jadwal").value=order.Jadwal||"";
  document.getElementById("Status").value=order.Status||"Dipesan";
  document.getElementById("Berat").value=order.Berat||0;
  document.getElementById("Harga").value=order.Harga||0;
  document.getElementById("detailModal").style.display="flex";
}
function closeModal(){ document.getElementById("detailModal").style.display="none"; }

function saveOrder(){
  if(!confirm("Yakin update data ini?")) return;
  const payload={
    Nama:document.getElementById("Nama").value,
    Alamat:document.getElementById("Alamat").value,
    "No HP":document.getElementById("NoHP").value,
    Layanan:document.getElementById("Layanan").value,
    Catatan:document.getElementById("Catatan").value,
    Jadwal:document.getElementById("Jadwal").value,
    Status:document.getElementById("Status").value,
    Berat:document.getElementById("Berat").value,
    Harga:document.getElementById("Harga").value
  };
  const rowIndex=document.getElementById("rowIndex").value;
  fetch(GAS_URL,{method:"POST",body:JSON.stringify({type:"UpdateOrder",rowIndex,payload})})
  .then(res=>res.json())
  .then(r=>{
    if(r.result==="ok"){
      showNotif("‚úÖ Data berhasil disimpan");
      seenOrders.add(String(rowIndex));
      saveSeenOrders();
      closeModal();
      loadOrders();
    } else { showNotif("‚ö†Ô∏è Gagal update","error"); }
  })
  .catch(err=>{console.error(err);showNotif("‚ö†Ô∏è Gagal update","error");});
}

/* Filter */
document.getElementById("searchInput").addEventListener("input",applyFilter);
document.getElementById("statusFilter").addEventListener("change",applyFilter);
function applyFilter(){
  const q=document.getElementById("searchInput").value.toLowerCase();
  const st=document.getElementById("statusFilter").value;
  const filtered=currentData.filter(o=>{
    const matchText=(o.Nama||"").toLowerCase().includes(q)||(o.Alamat||"").toLowerCase().includes(q);
    const matchStatus=!st||o.Status===st;
    return matchText&&matchStatus;
  });
  renderCards(filtered);
}

window.addEventListener("DOMContentLoaded",loadOrders);
</script>
</body>
</html>
