<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Aplikasi Laundry</title>
  <style>
    body {font-family: Arial, sans-serif; margin:20px;}
    table {width:100%; border-collapse:collapse; margin-top:10px;}
    th, td {border:1px solid #ccc; padding:8px; text-align:left;}
    th {background:#f2f2f2;}
    button {margin:2px; padding:4px 8px;}
    .modal {display:none; position:fixed; z-index:1000; left:0; top:0;
      width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;}
    .modal .box {background:#fff; padding:20px; border-radius:8px;
      max-width:90%; max-height:90%; overflow:auto;}
    .notif {position:fixed; top:20px; right:20px; padding:10px 15px;
      border-radius:4px; color:#fff; z-index:2000;}
    .success {background:#4CAF50;} .error{background:#f44336;}
    .actions {display:flex; flex-wrap:wrap; gap:4px;}
    #reportPages canvas { 
      margin: 0 auto 12px; 
      display: block; 
      max-width: 100%; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
    }
  </style>

  <!-- jsPDF & AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
  <h2>Manajemen Order Laundry</h2>
  <button id="addOrderBtn">‚ûï Tambah Order</button>
  <button id="reportBtn">üìë Preview Report</button>
  <input type="text" id="searchInput" placeholder="Cari nama/no hp..." style="margin-left:10px; padding:5px;">

  <table id="orderTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>No HP</th>
        <th>Layanan</th>
        <th>Berat (Kg)</th>
        <th>Harga (Rp)</th>
        <th>Status</th>
        <th>Jadwal</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal Form Order -->
  <div id="orderModal" class="modal">
    <div class="box">
      <h3 id="modalTitle">Tambah Order</h3>
      <form id="orderForm">
        <input type="hidden" id="editIndex">
        <label>Nama: <input type="text" id="nama" required></label><br><br>
        <label>No HP: <input type="text" id="nohp" required></label><br><br>
        <label>Layanan:
          <select id="layanan">
            <option value="Cuci Kering">Cuci Kering</option>
            <option value="Cuci Setrika">Cuci Setrika</option>
            <option value="Setrika">Setrika</option>
          </select>
        </label><br><br>
        <label>Berat (Kg): <input type="number" id="berat" required></label><br><br>
        <label>Status:
          <select id="status">
            <option value="Dipesan">Dipesan</option>
            <option value="Dijemput">Dijemput</option>
            <option value="Diproses">Diproses</option>
            <option value="Selesai">Selesai</option>
            <option value="Diantar">Diantar</option>
          </select>
        </label><br><br>
        <label>Jadwal: <input type="datetime-local" id="jadwal"></label><br><br>
        <button type="submit">Simpan</button>
        <button type="button" id="cancelBtn">Batal</button>
      </form>
    </div>
  </div>

  <!-- Modal Report pakai PDF.js -->
  <div id="reportModal" class="modal" aria-hidden="true">
    <div class="box" style="width:98%;max-width:none;height:95vh;">
      <h3>Preview Laporan Orders</h3>
      <div id="reportPages" style="flex:1;overflow:auto;height:80%;border:1px solid #ccc;padding:6px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px">
        <select id="reportStatusFilter">
          <option value="">Semua Status</option>
          <option value="Dipesan">Dipesan</option>
          <option value="Dijemput">Dijemput</option>
          <option value="Diproses">Diproses</option>
          <option value="Selesai">Selesai</option>
          <option value="Diantar">Diantar</option>
        </select>
        <button id="applyReportFilter">üîç Filter</button>
        <button id="zoomInBtn">üîç‚ûï Zoom In</button>
        <button id="zoomOutBtn">üîç‚ûñ Zoom Out</button>
        <button id="fitWidthBtn">‚ÜîÔ∏è Fit to Width</button>
        <button id="prevPageBtn">‚¨ÖÔ∏è Prev</button>
        <span id="pageInfo">Halaman 1 / 1</span>
        <button id="nextPageBtn">‚û°Ô∏è Next</button>
        <button id="downloadReportBtn">‚¨áÔ∏è Download PDF</button>
        <button id="closeReportModalBtn">‚ùå Tutup</button>
      </div>
    </div>
  </div>

  <div id="notif" class="notif" style="display:none;"></div>
<script>
let orders = JSON.parse(localStorage.getItem("orders")) || [];
let currentData = orders;

function saveData(){ localStorage.setItem("orders", JSON.stringify(orders)); }

function showNotif(msg,type){
  const n=document.getElementById("notif");
  n.textContent=msg; n.className=`notif ${type}`; n.style.display="block";
  setTimeout(()=>{n.style.display="none";},3000);
}

function renderTable(data){
  const tbody=document.querySelector("#orderTable tbody");
  tbody.innerHTML="";
  data.forEach((o,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${o.Nama}</td>
      <td>${o["No HP"]}</td>
      <td>${o.Layanan}</td>
      <td>${o.Berat}</td>
      <td>${parseInt(o.Harga).toLocaleString("id-ID")}</td>
      <td>${o.Status}</td>
      <td>${o.Jadwal ? new Date(o.Jadwal).toLocaleString("id-ID"):"-"}</td>
      <td class="actions">
        <button onclick="editOrder(${i})">‚úèÔ∏è</button>
        <button onclick="deleteOrder(${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
renderTable(orders);

// Form tambah/edit
document.getElementById("addOrderBtn").addEventListener("click",()=>{
  document.getElementById("modalTitle").textContent="Tambah Order";
  document.getElementById("orderForm").reset();
  document.getElementById("editIndex").value="";
  document.getElementById("orderModal").style.display="flex";
});
document.getElementById("cancelBtn").addEventListener("click",()=>{
  document.getElementById("orderModal").style.display="none";
});
document.getElementById("orderForm").addEventListener("submit",e=>{
  e.preventDefault();
  const obj={
    Nama:document.getElementById("nama").value,
    "No HP":document.getElementById("nohp").value,
    Layanan:document.getElementById("layanan").value,
    Berat:parseFloat(document.getElementById("berat").value)||0,
    Harga:(parseFloat(document.getElementById("berat").value)||0)*7000,
    Status:document.getElementById("status").value,
    Jadwal:document.getElementById("jadwal").value
  };
  const idx=document.getElementById("editIndex").value;
  if(idx===""){ orders.push(obj); showNotif("Order ditambah","success"); }
  else { orders[idx]=obj; showNotif("Order diupdate","success"); }
  saveData(); renderTable(orders);
  document.getElementById("orderModal").style.display="none";
});
function editOrder(i){
  const o=orders[i];
  document.getElementById("modalTitle").textContent="Edit Order";
  document.getElementById("nama").value=o.Nama;
  document.getElementById("nohp").value=o["No HP"];
  document.getElementById("layanan").value=o.Layanan;
  document.getElementById("berat").value=o.Berat;
  document.getElementById("status").value=o.Status;
  document.getElementById("jadwal").value=o.Jadwal;
  document.getElementById("editIndex").value=i;
  document.getElementById("orderModal").style.display="flex";
}
function deleteOrder(i){
  if(confirm("Hapus order ini?")){
    orders.splice(i,1);
    saveData(); renderTable(orders); showNotif("Order dihapus","success");
  }
}

// Search
document.getElementById("searchInput").addEventListener("keyup",()=>{
  const v=document.getElementById("searchInput").value.toLowerCase();
  currentData=orders.filter(o=>o.Nama.toLowerCase().includes(v)||o["No HP"].toLowerCase().includes(v));
  renderTable(currentData);
});

// ======= PREVIEW REPORT pakai PDF.js =======
let reportScale=1.2, reportPdf=null, fitToWidth=false, currentPage=1;

function renderReportPage(pageNum){
  const container=document.getElementById("reportPages");
  container.innerHTML="";
  if(!reportPdf) return;
  reportPdf.getPage(pageNum).then(page=>{
    let viewport=page.getViewport({scale:reportScale});
    if(fitToWidth){
      const cw=container.clientWidth-20;
      const s=cw/viewport.width;
      viewport=page.getViewport({scale:s});
    }
    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");
    canvas.width=viewport.width; canvas.height=viewport.height;
    container.appendChild(canvas);
    page.render({canvasContext:ctx,viewport});
    document.getElementById("pageInfo").textContent=`Halaman ${pageNum} / ${reportPdf.numPages}`;
  });
}

function generateReportPreview(){
  const sf=document.getElementById("reportStatusFilter").value;
  const filtered=sf?currentData.filter(o=>o.Status===sf):currentData;
  if(!filtered.length){ showNotif("Tidak ada order untuk preview","error"); return; }
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'pt',format:'a4'});
  doc.text("Preview Laporan Orders",297.5,30,{align:"center"});
  doc.autoTable({
    head:[["No","Nama","No HP","Layanan","Berat (Kg)","Harga (Rp)","Status","Jadwal"]],
    body:filtered.map((o,i)=>[
      i+1,o.Nama||"-",o["No HP"]||"-",o.Layanan||"-",o.Berat||0,
      (parseInt(o.Harga)||0).toLocaleString("id-ID"),
      o.Status||"-",o.Jadwal?new Date(o.Jadwal).toLocaleString("id-ID"):"-"
    ]),
    startY:50
  });
  const pdfData=doc.output("arraybuffer");
  document.getElementById("reportPages").innerHTML="<p style='text-align:center;color:#555'>Memuat preview...</p>";
  pdfjsLib.getDocument({data:pdfData}).promise.then(pdf=>{
    reportPdf=pdf; currentPage=1; renderReportPage(currentPage);
  }).catch(err=>{
    console.error("Preview gagal:",err);
    showNotif("‚ö†Ô∏è Preview gagal, coba download","error");
  });
}

// Event Modal
document.getElementById("reportBtn").addEventListener("click",()=>{ 
  document.getElementById("reportModal").style.display="flex"; 
  generateReportPreview();
});
document.getElementById("closeReportModalBtn").addEventListener("click",()=>{ 
  document.getElementById("reportModal").style.display="none"; 
});
document.getElementById("applyReportFilter").addEventListener("click",generateReportPreview);

// Navigasi
document.getElementById("prevPageBtn").addEventListener("click",()=>{ if(currentPage>1){currentPage--;renderReportPage(currentPage);} });
document.getElementById("nextPageBtn").addEventListener("click",()=>{ if(currentPage<reportPdf.numPages){currentPage++;renderReportPage(currentPage);} });
// Zoom
document.getElementById("zoomInBtn").addEventListener("click",()=>{ reportScale+=0.2; renderReportPage(currentPage); });
document.getElementById("zoomOutBtn").addEventListener("click",()=>{ if(reportScale>0.4){reportScale-=0.2;renderReportPage(currentPage);} });
document.getElementById("fitWidthBtn").addEventListener("click",()=>{ fitToWidth=!fitToWidth; renderReportPage(currentPage); });

// Download
document.getElementById("downloadReportBtn").addEventListener("click",()=>{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'pt',format:'a4'});
  doc.text("Laporan Orders",297.5,30,{align:"center"});
  doc.autoTable({
    head:[["No","Nama","No HP","Layanan","Berat (Kg)","Harga (Rp)","Status","Jadwal"]],
    body:orders.map((o,i)=>[
      i+1,o.Nama||"-",o["No HP"]||"-",o.Layanan||"-",o.Berat||0,
      (parseInt(o.Harga)||0).toLocaleString("id-ID"),
      o.Status||"-",o.Jadwal?new Date(o.Jadwal).toLocaleString("id-ID"):"-"
    ]),
    startY:50
  });
  const fn=`Laporan_Orders_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(fn);
});
</script>
</body>
</html>
