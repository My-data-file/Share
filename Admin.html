<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sea Laundry Admin</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:0; }
header { background:#1f2937; color:white; padding:15px; text-align:center; }
.container { padding:20px; }

/* Tombol */
button { padding:7px 14px; margin:5px 0; cursor:pointer; border:none; border-radius:5px; background:#2563eb; color:white; font-weight:bold; transition: background 0.2s;}
button:hover { background:#1e40af; }

/* Filter per kolom */
input, select { padding:6px; border:1px solid #ccc; border-radius:5px; font-size:13px; }
.filter-bar { 
  display:flex; 
  flex-wrap:wrap; 
  gap:10px; 
  align-items:center; 
  justify-content:center;  /* tombol ditengah */
  margin-bottom:10px; 
}

/* Dashboard */
#dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:15px; margin-bottom:20px; }
.card { 
  padding:15px; 
  border-radius:10px; 
  box-shadow:0 2px 6px rgba(0,0,0,0.1); 
  text-align: center; /* baru ditambahkan */
}
.card h3 { font-size:14px; color:#374151; margin:0; }
.card p { font-size:20px; font-weight:bold; margin:5px 0 0; }

/* Tabel */
.table-container { width:100%; overflow-x:auto; background:white; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
table { width:100%; border-collapse: collapse; min-width:1000px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; font-size:13px; }
th { background:#e5e7eb; position:sticky; top:0; z-index:2; }
tbody tr:nth-child(even) { background:#f9fafb; }

/* Hover row */
tbody tr:hover { background:#e0f2fe !important; }

/* Highlight filter aktif */
thead input:focus {
  border: 2px solid #2563eb;
  outline: none;
  background: #f0f9ff;
}

/* Notifikasi */
#notif { display:none; padding:10px; margin-bottom:10px; border-radius:5px; font-weight:bold; }
#notif.success { background:#d1fae5; color:#065f46; }
#notif.error { background:#fee2e2; color:#991b1b; }

/* Animasi flash setelah update */
@keyframes flashGreen {
  from { background-color: #bbf7d0; }
  to { background-color: inherit; }
}
tr.flash { animation: flashGreen 1.5s ease-out; }

/* Responsif */
@media (max-width:768px){
  table, th, td { font-size:12px; padding:6px; }
  .filter-bar { flex-direction:column; align-items:flex-start; }
}
</style>
</head>
<body>

<header>
  <h1>Admin Panel - Sea Laundry</h1>
</header>

<div class="container">
  <div id="notif"></div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="card" style="background:#bfdbfe;">
      <h3>Jumlah Pemesan</h3>
      <p id="totalOrders">0</p>
    </div>
    <div class="card" style="background:#bbf7d0;">
      <h3>Total Berat (Kg)</h3>
      <p id="totalWeight">0 Kg</p>
    </div>
    <div class="card" style="background:#fef08a;">
      <h3>Total Pemasukan</h3>
      <p id="totalIncome">Rp 0</p>
    </div>
    <div class="card" style="background:#ddd6fe;">
      <h3>Order Aktif</h3>
      <p id="activeOrders">0</p>
    </div>
    <div class="card" style="background:#e5e7eb;">
      <h3>Order Selesai</h3>
      <p id="completedOrders">0</p>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <button onclick="confirmRefresh()">üîÑ Refresh Orders</button>
  </div>

  <div class="table-container">
    <table id="ordersTable">
<thead>
  <tr>
    <th>No</th>
    <th>Nama<br><input type="text" placeholder="Filter" oninput="filterColumn(event,1)"></th>
    <th>Alamat<br><input type="text" placeholder="Filter" oninput="filterColumn(event,2)"></th>
    <th>No HP<br><input type="text" placeholder="Filter" oninput="filterColumn(event,3)"></th>
    <th>Layanan<br><input type="text" placeholder="Filter" oninput="filterColumn(event,4)"></th>
    <th>Catatan<br><input type="text" placeholder="Filter" oninput="filterColumn(event,5)"></th>
    <th>Jadwal<br><input type="text" placeholder="Filter" oninput="filterColumn(event,6)"></th>
    <th>Maps</th>
    <th>Status</th>
    <th>Berat (Kg)<br><input type="text" placeholder="Filter" oninput="filterColumn(event,9)"></th>
    <th>Harga (Rp)<br><input type="text" placeholder="Filter" oninput="filterColumn(event,10)"></th>
    <th>Aksi</th>
  </tr>
</thead>
      <tbody>
        <tr><td colspan="12" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwJax3FO_zvxRrsYtL6X_3xsmZAWG9gwxSs-ljpvGvMCR003h0qjf3_rq7wMDn2yv8Z5A/exec";
let currentData = [];
const statusOptions = ["Dipesan", "Dijemput", "Diproses", "Selesai", "Diantar"];

/* Notifikasi */
function showNotif(msg,type="success"){
  const notif=document.getElementById("notif");
  notif.textContent=msg;
  notif.className=type==="success"?"success":"error";
  notif.style.display="block";
  setTimeout(()=>notif.style.display="none",3000);
}

/* Refresh dengan konfirmasi */
function confirmRefresh(){
  if(confirm("Yakin mau reload data order?")){
    loadOrders();
  }
}

/* Load data */
function loadOrders(){
  fetch(GAS_URL,{
    method:"POST",
    body: JSON.stringify({ type:"GetAllOrders" })
  })
  .then(res=>res.json())
  .then(data=>{
    currentData=data.orders||[];
    renderTable(currentData);
    updateDashboard(currentData);
  })
  .catch(err=>{
    console.error(err);
    showNotif("‚ö†Ô∏è Gagal load order","error");
  });
}

/* Render tabel */
function renderTable(data){
  const tbody=document.querySelector("#ordersTable tbody");
  tbody.innerHTML="";
  if(!data||data.length===0){
    tbody.innerHTML="<tr><td colspan='12' style='text-align:center;'>Tidak ada order</td></tr>";
    return;
  }
  data.forEach((o,i)=>{
    const noHp=o["No HP"]?.toString()||"";
    const harga=o.Harga||0;
    const berat=o.Berat||0;
    const formattedHP=noHp.startsWith("62")?"0"+noHp.slice(2):noHp;
    const formattedHarga=parseInt(harga).toLocaleString("id-ID");
    const date=new Date(o.Jadwal);
    const formattedDate=isNaN(date)?o.Jadwal:(("0"+date.getDate()).slice(-2)+"-"+("0"+(date.getMonth()+1)).slice(-2)+"-"+date.getFullYear()+" "+("0"+date.getHours()).slice(-2)+":"+("0"+date.getMinutes()).slice(-2));
    
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td contenteditable="true" data-key="Nama">${o.Nama||""}</td>
      <td contenteditable="true" data-key="Alamat">${o.Alamat||""}</td>
      <td contenteditable="true" data-key="No HP">${formattedHP}</td>
      <td contenteditable="true" data-key="Layanan">${o.Layanan||""}</td>
      <td contenteditable="true" data-key="Catatan">${o.Catatan||""}</td>
      <td contenteditable="true" data-key="Jadwal">${formattedDate}</td>
      <td><a href="${o.Maps||'#'}" target="_blank">Lihat</a></td>
      <td>
        <select data-key="Status">
          ${statusOptions.map(s => `<option value="${s}" ${o.Status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td contenteditable="true" data-key="Berat">${berat}</td>
      <td contenteditable="true" data-key="Harga">${formattedHarga}</td>
      <td><button onclick="updateRow(this,${o.rowIndex})">Update</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* Update row */
function updateRow(btn,rowIndex){
  if(!confirm("Yakin update data row ini?")) return;
  const tr=btn.closest("tr");
  const payload={};
  tr.querySelectorAll("[contenteditable], select").forEach(el=>{
    payload[el.dataset.key]=el.value?.trim() ?? el.textContent.trim();
  });

  fetch(GAS_URL,{
    method:"POST",
    body: JSON.stringify({type:"UpdateOrder", rowIndex, payload})
  })
  .then(res=>res.json())
  .then(r=>{
    if(r.result==="ok"){
      showNotif("‚úÖ Data berhasil disimpan","success");
      // update langsung
      tr.querySelectorAll("[contenteditable]").forEach(td=>{
        if(payload[td.dataset.key]) td.textContent=payload[td.dataset.key];
      });
      const sel=tr.querySelector("select[data-key='Status']");
      if(sel) sel.value=payload.Status||sel.value;
      // flash hijau
      tr.classList.add("flash");
      setTimeout(()=>tr.classList.remove("flash"),1500);
    }else{
      showNotif("‚ö†Ô∏è Gagal update","error");
    }
  })
  .catch(err=>{
    console.error(err);
    showNotif("‚ö†Ô∏è Gagal update","error");
  });
}

/* Filter per kolom */
function filterColumn(e,index){
  const val=e.target.value.toLowerCase();
  const rows=document.querySelectorAll("#ordersTable tbody tr");
  rows.forEach(r=>{
    const td=r.children[index];
    if(td){
      r.style.display=td.textContent.toLowerCase().includes(val)?"":"none";
    }
  });
}

/* Dashboard */
function updateDashboard(data){
  let totalOrders=data.length;
  let totalWeight=data.reduce((sum,o)=>sum+parseFloat(o.Berat||0),0);
  let totalIncome=data.reduce((sum,o)=>sum+parseFloat(o.Harga||0),0);
  let activeOrders=data.filter(o=>!["Selesai","Diantar"].includes(o.Status)).length;
  let completedOrders=data.filter(o=>["Selesai","Diantar"].includes(o.Status)).length;
  document.getElementById("totalOrders").textContent=totalOrders;
  document.getElementById("totalWeight").textContent=totalWeight.toFixed(2)+" Kg";
  document.getElementById("totalIncome").textContent="Rp "+totalIncome.toLocaleString("id-ID");
  document.getElementById("activeOrders").textContent=activeOrders;
  document.getElementById("completedOrders").textContent=completedOrders;
}

window.addEventListener("DOMContentLoaded",loadOrders);
</script>

</body>
</html>
