<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sea Laundry Admin</title>
<style>
/* Warna hijau untuk order diantar */
tr.status-diantar { background-color: #d1fae5 !important; }

body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:0;
  overflow-x:auto; /* bisa geser horizontal dari mana saja */
}
header { background:#1f2937; color:white; padding:15px; text-align:center; }
.container { padding:20px; }

/* Tombol */
button { padding:7px 14px; margin:5px 0; cursor:pointer; border:none; border-radius:5px; background:#2563eb; color:white; font-weight:bold; transition: background 0.2s;}
button:hover { background:#1e40af; }

/* Filter per kolom */
input, select { padding:6px; border:1px solid #ccc; border-radius:5px; font-size:13px; }
.filter-bar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin-bottom:10px; }

/* Dashboard */
#dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:15px; margin-bottom:20px; }
.card { padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align: center; }
.card h3 { font-size:14px; color:#374151; margin:0; }
.card p { font-size:20px; font-weight:bold; margin:5px 0 0; }

/* Tabel */
.table-container {
  width:100%;
  overflow-x:auto;    /* drag/scroll di container (tetap responsif) */
  background:white;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);
  position:relative;
  cursor: grab;
}
.table-container:active { cursor: grabbing; }

table { width:100%; border-collapse: collapse; min-width:1000px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; font-size:13px; }
th { background:#e5e7eb; } /* header normal (we use cloned fixed header for stickiness) */
tbody tr:nth-child(even) { background:#f9fafb; }

/* Hover row */
tbody tr:hover { background:#e0f2fe !important; }

/* Sticky kolom Nama (data rows) */
th:nth-child(2), td:nth-child(2) {
  position: sticky;
  left: 0;
  z-index: 5;
  /* beri background dan garis pemisah agar tidak tembus */
  background: #fff;
  border-right: 1px solid #ccc;
}
tbody tr:nth-child(even) td:nth-child(2) { background: #f9fafb; }
tbody tr:hover td:nth-child(2) { background: #e0f2fe !important; }
th:nth-child(2) { background:#e5e7eb; }

/* cloned header (fixed) */
.cloned-header {
  position: fixed;
  top: 0; /* di atas viewport */
  left: 0;
  overflow: hidden;
  pointer-events: auto; /* kita akan forward input ke original */
  z-index: 9998;
  display: none; /* tampilkan hanya saat perlu */
  background: transparent;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.cloned-header table {
  border-collapse: collapse;
  table-layout: fixed;
}
.cloned-header th, .cloned-header td {
  box-sizing: border-box;
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:13px;
  background:#e5e7eb;
}

/* pastikan cloned header nama terlihat seperti header nyata */
.cloned-header th:nth-child(2) {
  background:#e5e7eb;
  border-right: 1px solid #ccc;
}

/* Notifikasi Tengah */
.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  min-width: 250px;
  max-width: 80%;
  padding: 15px 20px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: bold;
  text-align: center;
  display: none;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.toast.success { background:#16a34a; color:white; }
.toast.error { background:#dc2626; color:white; }

/* Animasi flash setelah update */
@keyframes flashGreen { from { background-color: #bbf7d0; } to { background-color: inherit; } }
tr.flash { animation: flashGreen 1.5s ease-out; }

/* Responsif */
@media (max-width:768px){
  table, th, td { font-size:12px; padding:6px; }
  .filter-bar { flex-direction:column; align-items:center; justify-content:center; }
}

/* Input search di tabel center */
th input { display:block; margin:5px auto; text-align:center; width: 90%; box-sizing: border-box; }
</style>
</head>
<body>

<header>
  <h1>Admin Panel - Sea Laundry</h1>
</header>

<div class="container">
  <div id="notif" class="toast"></div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="card" style="background:#bfdbfe;">
      <h3>Jumlah Pemesan</h3><p id="totalOrders">0</p>
    </div>
    <div class="card" style="background:#bbf7d0;">
      <h3>Total Berat (Kg)</h3><p id="totalWeight">0 Kg</p>
    </div>
    <div class="card" style="background:#fef08a;">
      <h3>Total Pemasukan</h3><p id="totalIncome">Rp 0</p>
    </div>
    <div class="card" style="background:#ddd6fe;">
      <h3>Order Aktif</h3><p id="activeOrders">0</p>
    </div>
    <div class="card" style="background:#e5e7eb;">
      <h3>Order Selesai</h3><p id="completedOrders">0</p>
    </div>
  </div>

  <!-- Notifikasi Order Baru -->
  <div id="newOrdersBox" style="padding:10px; margin:10px 0; border:2px solid #2563eb; border-radius:8px; background:#eff6ff;">
    <h3 style="margin:0 0 10px 0; color:#1e40af;">üì¢ Pesanan Baru</h3>
    <ul id="newOrdersList" style="list-style:none; padding:0; margin:0;"></ul>
  </div>

  <div class="filter-bar">
    <button onclick="confirmRefresh()">üîÑ Refresh Orders</button>
  </div>

  <div class="table-container">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>No</th>
          <th>Nama<br><input type="text" placeholder="Search" oninput="filterColumn(event,1)"></th>
          <th>Alamat<br><input type="text" placeholder="Search" oninput="filterColumn(event,2)"></th>
          <th>No HP<br><input type="text" placeholder="Search" oninput="filterColumn(event,3)"></th>
          <th>Layanan<br><input type="text" placeholder="Search" oninput="filterColumn(event,4)"></th>
          <th>Catatan<br><input type="text" placeholder="Search" oninput="filterColumn(event,5)"></th>
          <th>Jadwal<br><input type="text" placeholder="Search" oninput="filterColumn(event,6)"></th>
          <th>Maps</th>
          <th>Status</th>
          <th>Berat (Kg)<br><input type="text" placeholder="Search" oninput="filterColumn(event,9)"></th>
          <th>Harga (Rp)<br><input type="text" placeholder="Search" oninput="filterColumn(event,10)"></th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="12" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- cloned header container will be injected here by JS -->
<div id="clonedHeaderContainer" class="cloned-header" aria-hidden="true"></div>

<script>
/* ---------- YOUR EXISTING APP LOGIC (GAS_URL, loadOrders, renderTable, updateRow, dll.) ---------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwJax3FO_zvxRrsYtL6X_3xsmZAWG9gwxSs-ljpvGvMCR003h0qjf3_rq7wMDn2yv8Z5A/exec";
let currentData = [];
const statusOptions = ["Dipesan", "Dijemput", "Diproses", "Selesai", "Diantar"];

let knownOrders = new Set();
let seenOrders = new Set(JSON.parse(localStorage.getItem("seenOrders") || "[]"));
function saveSeenOrders() { localStorage.setItem("seenOrders", JSON.stringify([...seenOrders])); }

function showNotif(msg, type="success") {
  const notif = document.getElementById("notif");
  notif.textContent = msg;
  notif.className = "toast " + (type === "success" ? "success" : "error");
  notif.style.display = "block";
  setTimeout(() => notif.style.display = "none", 2000);
}

function confirmRefresh() {
  if (confirm("Yakin mau reload data order?")) {
    loadOrders();
    showNotif("üîÑ Data berhasil direfresh","success");
  }
}

/* Highlight Pesanan Baru */
function highlightNewOrders(data){
  const box = document.getElementById("newOrdersBox");
  const list = document.getElementById("newOrdersList");
  list.innerHTML = ""; // reset daftar lama

  let pendingOrders = data.filter(o => o.Status === "Dipesan" && !seenOrders.has(String(o.rowIndex)));

  if(pendingOrders.length > 0){
    box.style.display = "block";
    pendingOrders.forEach(o => {
      const li = document.createElement("li");
      li.style.marginBottom = "6px";
      li.innerHTML = `
        <span><b>${o.Nama||"Tanpa Nama"}</b> - ${o.Layanan||""}</span>
        <button style="margin-left:10px; padding:2px 8px; font-size:12px;" 
          onclick="gotoOrder(${o.rowIndex}, this)">Lihat</button>`;
      list.appendChild(li);
    });
  } else {
    box.style.display = "block";
    const li = document.createElement("li");
    li.textContent = "Tidak ada order baru";
    li.style.fontStyle = "italic";
    li.style.color = "#555";
    list.appendChild(li);
  }
}

/* Tombol Lihat */
function gotoOrder(rowIndex, btn) {
  const row = [...document.querySelectorAll("#ordersTable tbody tr")]
    .find(r => r.querySelector("button")?.onclick.toString().includes(rowIndex));
  if (row) {
    row.scrollIntoView({ behavior: "smooth", block: "center" });
    row.classList.add("flash");
    setTimeout(() => row.classList.remove("flash"), 1500);
  }
}

/* Load data dari GAS */
function loadOrders() {
  fetch(GAS_URL, { method:"POST", body: JSON.stringify({ type:"GetAllOrders" }) })
  .then(res => res.json())
  .then(data => {
    currentData = data.orders || [];
    renderTable(currentData);
    updateDashboard(currentData);
    highlightNewOrders(currentData);
    syncClonedHeader(); // sync header widths after table rendered
  })
  .catch(err => { console.error(err); showNotif("‚ö†Ô∏è Gagal load order", "error"); });
}

/* Render tabel (sama seperti sebelumnya) */
function renderTable(data) {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";
  if (!data || data.length===0) { tbody.innerHTML = "<tr><td colspan='12' style='text-align:center;'>Tidak ada order</td></tr>"; return; }
  data.forEach((o,i)=>{
    const noHp=o["No HP"]?.toString()||"";
    const harga=o.Harga||0;
    const berat=o.Berat||0;
    const formattedHP=noHp.startsWith("62")?"0"+noHp.slice(2):noHp;
    const formattedHarga= isNaN(parseInt(harga)) ? harga : parseInt(harga).toLocaleString("id-ID");
    const date=new Date(o.Jadwal);
    const formattedDate=isNaN(date)?o.Jadwal: (("0"+date.getDate()).slice(-2) + "-" + ("0"+(date.getMonth()+1)).slice(-2) + "-" + date.getFullYear() + " " + ("0"+date.getHours()).slice(-2)+":"+("0"+date.getMinutes()).slice(-2));
    
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td contenteditable="true" data-key="Nama">${o.Nama||""}</td>
      <td contenteditable="true" data-key="Alamat">${o.Alamat||""}</td>
      <td contenteditable="true" data-key="No HP">${formattedHP}</td>
      <td contenteditable="true" data-key="Layanan">${o.Layanan||""}</td>
      <td contenteditable="true" data-key="Catatan">${o.Catatan||""}</td>
      <td contenteditable="true" data-key="Jadwal">${formattedDate}</td>
      <td><a href="${o.Maps||'#'}" target="_blank">Lihat</a></td>
      <td>
        <select data-key="Status">
          ${statusOptions.map(s=>`<option value="${s}" ${o.Status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td contenteditable="true" data-key="Berat">${berat}</td>
      <td contenteditable="true" data-key="Harga">${formattedHarga}</td>
      <td><button onclick="updateRow(this,${o.rowIndex})">Update</button></td>
    `;
    if (o.Status==="Diantar") tr.classList.add("status-diantar");
    const statusSelect = tr.querySelector("select[data-key='Status']");
    statusSelect.addEventListener("change",function(){
      if(this.value==="Diantar") tr.classList.add("status-diantar");
      else tr.classList.remove("status-diantar");
    });
    tbody.appendChild(tr);
  });

  // after render, update cloned header sizes
  setTimeout(syncClonedHeader, 50);
}

function updateRow(btn, rowIndex) {
  if (!confirm("Yakin update data row ini?")) return;
  const tr = btn.closest("tr");
  const payload = {};
  tr.querySelectorAll("[contenteditable], select").forEach(el => {
    payload[el.dataset.key] = el.value?.trim() ?? el.textContent.trim();
  });

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({ type:"UpdateOrder", rowIndex, payload })
  })
  .then(res => res.json())
  .then(r => {
    if (r.result === "ok") {
      showNotif("‚úÖ Data berhasil disimpan", "success");
      tr.classList.add("flash");
      setTimeout(() => tr.classList.remove("flash"), 1500);

      if(payload.Status && payload.Status !== "Dipesan") {
        seenOrders.add(String(rowIndex));
        saveSeenOrders();
        highlightNewOrders(currentData);
      }

    } else {
      showNotif("‚ö†Ô∏è Gagal update", "error");
    }
  })
  .catch(err => {
    console.error(err);
    showNotif("‚ö†Ô∏è Gagal update", "error");
  });
}

function filterColumn(e,index){
  const val=e.target.value.toLowerCase();
  const rows=document.querySelectorAll("#ordersTable tbody tr");
  rows.forEach(r=>{
    const td=r.children[index];
    if(td) r.style.display=td.textContent.toLowerCase().includes(val)?"":"none";
  });
}

function updateDashboard(data){
  let totalOrders=data.length;
  let totalWeight=data.reduce((sum,o)=>sum+parseFloat(o.Berat||0),0);
  let totalIncome=data.reduce((sum,o)=>sum+parseFloat(o.Harga||0),0);
  let activeOrders=data.filter(o=>!["Selesai","Diantar"].includes(o.Status)).length;
  let completedOrders=data.filter(o=>["Selesai","Diantar"].includes(o.Status)).length;
  document.getElementById("totalOrders").textContent=totalOrders;
  document.getElementById("totalWeight").textContent=totalWeight.toFixed(2)+" Kg";
  document.getElementById("totalIncome").textContent="Rp "+totalIncome.toLocaleString("id-ID");
  document.getElementById("activeOrders").textContent=activeOrders;
  document.getElementById("completedOrders").textContent=completedOrders;
}

/* ---------- CLONED HEADER IMPLEMENTATION (fixes "kepotong" issue) ---------- */
let clonedWrapper = null;
let clonedTable = null;
function createClonedHeader() {
  const container = document.getElementById("clonedHeaderContainer");
  const originalTable = document.getElementById("ordersTable");
  if (!originalTable || !container) return;

  // If already created, skip
  if (container.querySelector('table')) return;

  const thead = originalTable.querySelector('thead');
  if (!thead) return;

  // clone thead into a small table
  clonedTable = document.createElement('table');
  clonedTable.className = 'cloned-table';
  const cloneThead = thead.cloneNode(true);
  clonedTable.appendChild(cloneThead);
  container.appendChild(clonedTable);
  clonedWrapper = container;

  // forward input events from cloned header to original header inputs
  setupCloneInputForwarding();
  // initial sync
  syncClonedHeader();
}

function setupCloneInputForwarding(){
  const originalInputs = Array.from(document.querySelectorAll('#ordersTable thead input, #ordersTable thead select'));
  const cloneInputs = Array.from(document.querySelectorAll('#clonedHeaderContainer thead input, #clonedHeaderContainer thead select'));
  cloneInputs.forEach((cInput, idx) => {
    cInput.addEventListener('input', e => {
      const orig = originalInputs[idx];
      if (!orig) return;
      orig.value = e.target.value;
      // trigger original input event to filter
      orig.dispatchEvent(new Event('input', { bubbles: true }));
    });
    cInput.addEventListener('focus', e => {
      const orig = originalInputs[idx];
      if (orig) orig.focus();
    });
  });
}

function syncClonedHeader(){
  const originalTable = document.getElementById("ordersTable");
  const container = document.getElementById("clonedHeaderContainer");
  if (!originalTable || !container) return;

  // ensure cloned header exists
  createClonedHeader();

  const tableRect = originalTable.getBoundingClientRect();
  const theadCells = Array.from(originalTable.querySelectorAll('thead th'));
  const cloneCells = Array.from(container.querySelectorAll('thead th'));

  // set widths for cloned cells to match original
  cloneCells.forEach((c, i) => {
    const orig = theadCells[i];
    if (!orig) return;
    const w = Math.max(orig.getBoundingClientRect().width, orig.offsetWidth);
    c.style.width = w + 'px';
  });

  // set container/table widths
  const tblWidth = originalTable.getBoundingClientRect().width;
  container.style.width = tblWidth + 'px';
  clonedTable.style.width = tblWidth + 'px';

  // position left to match table
  container.style.left = (tableRect.left + window.scrollX) + 'px';
}

function updateClonedHeaderVisibility(){
  const originalTable = document.getElementById("ordersTable");
  const container = document.getElementById("clonedHeaderContainer");
  if (!originalTable || !container) return;
  const rect = originalTable.getBoundingClientRect();

  // show cloned header when table top scrolled above viewport top
  // and bottom is still visible (so header shouldn't show past table)
  if (rect.top < 0 && rect.bottom > 0) {
    container.style.display = 'block';
    // adjust left and width again to follow horizontal scroll
    syncClonedHeader();
  } else {
    container.style.display = 'none';
  }
}

/* update on scroll/resize and container scroll */
window.addEventListener('scroll', updateClonedHeaderVisibility, {passive:true});
window.addEventListener('resize', () => { syncClonedHeader(); updateClonedHeaderVisibility(); });
document.querySelectorAll('.table-container').forEach(tc => {
  tc.addEventListener('scroll', () => { syncClonedHeader(); updateClonedHeaderVisibility(); });
});

/* create on initial load */
window.addEventListener('DOMContentLoaded', () => {
  createClonedHeader();
  syncClonedHeader();
  updateClonedHeaderVisibility();
});

/* ---------- Drag-to-scroll for table-container ---------- */
(function() {
  const container = document.querySelector(".table-container");
  let isDown = false;
  let startX;
  let scrollLeft;

  if (container) {
    container.addEventListener("mousedown", e => {
      isDown = true;
      startX = e.pageX - container.offsetLeft;
      scrollLeft = container.scrollLeft;
    });
    container.addEventListener("mouseleave", () => isDown = false);
    container.addEventListener("mouseup", () => isDown = false);
    container.addEventListener("mousemove", e => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - container.offsetLeft;
      const walk = (x - startX) * 1;
      container.scrollLeft = scrollLeft - walk;
      // also sync cloned header position while dragging
      syncClonedHeader();
    });
    // also support touch dragging
    let touchStartX = 0, touchScrollLeft = 0;
    container.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].pageX - container.offsetLeft;
      touchScrollLeft = container.scrollLeft;
    }, {passive:true});
    container.addEventListener('touchmove', e => {
      const x = e.touches[0].pageX - container.offsetLeft;
      const walk = (x - touchStartX) * 1;
      container.scrollLeft = touchScrollLeft - walk;
      syncClonedHeader();
    }, {passive:true});
  }
})();

/* ---------- init load ---------- */
window.addEventListener("DOMContentLoaded", loadOrders);
</script>

</body>
</html>
