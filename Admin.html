<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sea Laundry Admin</title>

<!-- jsPDF & autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- pdf.js (buat render di HP/Laptop langsung ke canvas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:0}
  header{background:#1f2937;color:#fff;padding:14px 16px;text-align:center}
  .container{padding:18px;max-width:1200px;margin:0 auto}
  button{padding:7px 12px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
  button:hover{background:#1e40af}
  input,select{padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px;width:100%}
  #dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px}
  .card-summary{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);text-align:center}
  .card-summary h3{margin:0;font-size:13px;color:#374151}
  .card-summary p{margin:6px 0 0;font-weight:700;font-size:18px}
  .filter-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:14px}
  #ordersGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .order-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.08)}
  .status{display:inline-block;padding:4px 8px;border-radius:8px;font-weight:700;font-size:12px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center}
  .modal .box{background:#fff;border-radius:10px;padding:16px;width:98%;max-width:none;max-height:95vh;overflow:auto;display:flex;flex-direction:column}
  #reportPreview {border:1px solid #ccc;width:100%;height:auto;max-height:80vh;margin-bottom:8px}
  @media(max-width:640px){.filter-bar{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<header><h1>Admin Panel - Sea Laundry</h1></header>
<div class="container">
  <div id="dashboard">
    <div class="card-summary" style="background:#bfdbfe"><h3>Jumlah Pemesan</h3><p id="totalOrders">0</p></div>
    <div class="card-summary" style="background:#bbf7d0"><h3>Total Berat (Kg)</h3><p id="totalWeight">0 Kg</p></div>
    <div class="card-summary" style="background:#fef08a"><h3>Total Pemasukan</h3><p id="totalIncome">Rp 0</p></div>
  </div>
  <div class="filter-bar">
    <input id="searchInput" placeholder="üîç Cari nama / HP / layanan" />
    <select id="statusFilter">
      <option value="">Semua Status</option>
      <option value="Dipesan">Dipesan</option>
      <option value="Dijemput">Dijemput</option>
      <option value="Diproses">Diproses</option>
      <option value="Selesai">Selesai</option>
      <option value="Diantar">Diantar</option>
    </select>
    <button id="reportBtn">üìÑ Preview Report</button>
  </div>
  <div id="ordersGrid"></div>
</div>

<!-- MODAL PREVIEW REPORT -->
<div id="reportModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3>üìÑ Preview Laporan Orders</h3>
    <!-- Canvas untuk render PDF -->
    <canvas id="reportPreview"></canvas>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <select id="reportStatusFilter">
        <option value="">Semua Status</option>
        <option value="Dipesan">Dipesan</option>
        <option value="Dijemput">Dijemput</option>
        <option value="Diproses">Diproses</option>
        <option value="Selesai">Selesai</option>
        <option value="Diantar">Diantar</option>
      </select>
      <button id="applyReportFilter">üîç Filter</button>
      <button id="downloadReportBtn">‚¨áÔ∏è Download PDF</button>
      <button id="closeReportModalBtn">‚ùå Tutup</button>
    </div>
  </div>
</div>
<script>
const { jsPDF } = window.jspdf;
let currentData = [
  {Nama:"Andi", "No HP":"08123", Layanan:"Cuci Kering", Berat:5, Harga:25000, Status:"Diantar", Jadwal:new Date().toISOString()},
  {Nama:"Budi", "No HP":"08234", Layanan:"Setrika", Berat:3, Harga:15000, Status:"Selesai", Jadwal:new Date().toISOString()}
]; // contoh dummy, ganti dengan loadOrders()

// ===== Modal =====
document.getElementById("reportBtn").addEventListener("click",()=>{
  document.getElementById("reportModal").style.display="flex";
  generateReportPreview();
});
document.getElementById("closeReportModalBtn").addEventListener("click",()=>{
  document.getElementById("reportModal").style.display="none";
});
document.getElementById("applyReportFilter").addEventListener("click",generateReportPreview);

// ===== Generate Preview =====
async function generateReportPreview(){
  const statusFilter=document.getElementById("reportStatusFilter").value;
  const filtered=statusFilter?currentData.filter(o=>o.Status===statusFilter):currentData;
  if(!filtered.length){alert("Tidak ada data");return;}

  // Buat PDF pakai jsPDF
  const doc=new jsPDF({unit:"pt",format:"a4"});
  doc.text("Laporan Orders",297.5,30,{align:"center"});
  doc.autoTable({
    head:[["No","Nama","No HP","Layanan","Berat","Harga","Status","Jadwal"]],
    body:filtered.map((o,i)=>[
      i+1,
      o.Nama||"-",
      o["No HP"]||"-",
      o.Layanan||"-",
      o.Berat||0,
      (parseInt(o.Harga)||0).toLocaleString("id-ID"),
      o.Status||"-",
      o.Jadwal?new Date(o.Jadwal).toLocaleString("id-ID"):"-"
    ]),
    startY:50
  });

  // Convert ke blob
  const pdfBlob=doc.output("blob");
  const pdfUrl=URL.createObjectURL(pdfBlob);

  // Render PDF ke canvas via pdf.js
  const pdf=await pdfjsLib.getDocument(pdfUrl).promise;
  const page=await pdf.getPage(1);
  const scale=1.2;
  const viewport=page.getViewport({scale});
  const canvas=document.getElementById("reportPreview");
  const ctx=canvas.getContext("2d");
  canvas.height=viewport.height;
  canvas.width=viewport.width;
  await page.render({canvasContext:ctx,viewport}).promise;
}

// ===== Download =====
document.getElementById("downloadReportBtn").addEventListener("click",()=>{
  const statusFilter=document.getElementById("reportStatusFilter").value;
  const filtered=statusFilter?currentData.filter(o=>o.Status===statusFilter):currentData;
  if(!filtered.length){alert("Tidak ada data");return;}

  const doc=new jsPDF({unit:"pt",format:"a4"});
  doc.text("Laporan Orders",297.5,30,{align:"center"});
  doc.autoTable({
    head:[["No","Nama","No HP","Layanan","Berat","Harga","Status","Jadwal"]],
    body:filtered.map((o,i)=>[
      i+1,
      o.Nama||"-",
      o["No HP"]||"-",
      o.Layanan||"-",
      o.Berat||0,
      (parseInt(o.Harga)||0).toLocaleString("id-ID"),
      o.Status||"-",
      o.Jadwal?new Date(o.Jadwal).toLocaleString("id-ID"):"-"
    ]),
    startY:50
  });
  doc.save(`Laporan_${new Date().toISOString().slice(0,10)}.pdf`);
});
</script>
</body>
</html>
