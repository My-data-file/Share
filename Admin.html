<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sea Laundry Admin</title>

<!-- jsPDF dan autoTable CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:0}
  header{background:#1f2937;color:#fff;padding:14px 16px;text-align:center}
  .container{padding:18px;max-width:1200px;margin:0 auto}
  button{padding:7px 12px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
  button:hover{background:#1e40af}
  input,select,textarea{padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px;width:100%;box-sizing:border-box}
  textarea{min-height:60px}
  #dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px}
  .card-summary{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);text-align:center;transition:0.2s}
  .card-summary h3{margin:0;font-size:13px;color:#374151}
  .card-summary p{margin:6px 0 0;font-weight:700;font-size:18px}
  .card-summary:hover{transform: translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.15);}
  #newOrdersBox{background:#eff6ff;border:2px solid #2563eb;padding:10px;border-radius:8px;margin-bottom:12px;position:relative;transition:0.3s}
  #newOrdersBox h3{margin:0 0 8px;color:#1e40af;font-size:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
  #newOrdersBox h3::after{content:'‚ñº';font-size:12px;margin-left:8px;transition:transform 0.3s;}
  #newOrdersBox.collapsed h3::after{transform:rotate(-90deg);}
  #newOrdersBox.collapsed ul{display:none;}
  #newOrdersList{list-style:none;padding:0;margin:0}
  .filter-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:14px}
  #ordersGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .order-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:0.2s}
  .order-card:hover{transform: translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.15);}
  .order-card h4{margin:0 0 6px;color:#111827}
  .order-card p{margin:4px 0;color:#374151;font-size:14px}
  .status{display:inline-block;padding:4px 8px;border-radius:8px;font-weight:700;font-size:12px;margin-top:8px}
  .status.Dipesan{background:#fee2e2;color:#991b1b}
  .status.Dijemput{background:#dbeafe;color:#1e3a8a}
  .status.Diproses{background:#fef9c3;color:#92400e}
  .status.Selesai{background:#dcfce7;color:#166534}
  .status.Diantar{background:#d1fae5;color:#065f46}
  .order-card.diantar { background-color: #d1fae5; }
  .order-card button{width:100%;margin-top:10px}
  .order-card.highlight { box-shadow:0 0 12px 3px #2563eb; transition: box-shadow 0.3s; }
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center}
  .modal .box{background:#fff;border-radius:10px;padding:16px;width:94%;max-width:520px;max-height:90vh;overflow:auto; display:flex; flex-direction: column;}
  .modal h3{margin:0 0 10px}
  .modal .form-row{margin-bottom:8px}
  #orderModal .box div[style*="justify-content:flex-end"] button{min-width:100px}
  .toast{position:fixed;top:16px;right:16px;padding:12px 18px;border-radius:8px;color:#fff;font-weight:700;display:none;z-index:11000;transform:none}
  .toast.success{background:#16a34a}
  .toast.error{background:#dc2626}
  .loading-overlay {display: none;position: fixed;inset: 0;background: rgba(0,0,0,0.4);z-index: 12000;align-items: center;justify-content: center;flex-direction: column;color: #fff;font-weight: 600;font-size: 16px;}
  .spinner {width: 40px;height: 40px;border: 4px solid #fff;border-top: 4px solid #2563eb;border-radius: 50%;animation: spin 1s linear infinite;margin-bottom: 12px;}
  @keyframes spin { to { transform: rotate(360deg); } }
  @media (max-width:640px){
    .filter-bar{flex-direction:column;align-items:stretch}
    #dashboard{grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px;}
    #ordersGrid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;}
  }
</style>
</head>
<body>
<header><h1 style="margin:0">Admin Panel - Sea Laundry v1</h1></header>
<div class="container">
  <div id="notif" class="toast"></div>
  <div id="dashboard">
    <div class="card-summary" style="background:#bfdbfe"><h3>Jumlah Pemesan</h3><p id="totalOrders">0</p></div>
    <div class="card-summary" style="background:#bbf7d0"><h3>Total Berat (Kg)</h3><p id="totalWeight">0 Kg</p></div>
    <div class="card-summary" style="background:#fef08a"><h3>Total Pemasukan</h3><p id="totalIncome">Rp 0</p></div>
    <div class="card-summary" style="background:#ddd6fe"><h3>Order Aktif</h3><p id="activeOrders">0</p></div>
    <div class="card-summary" style="background:#e5e7eb"><h3>Order Selesai</h3><p id="completedOrders">0</p></div>
  </div>
  <div id="newOrdersBox">
    <h3>üì¢ Pesanan Baru</h3>
    <ul id="newOrdersList"></ul>
  </div>
  <div class="filter-bar">
    <input id="searchInput" placeholder="üîç Cari nama / HP / layanan" />
    <select id="statusFilter">
      <option value="">Semua Status</option>
      <option value="Dipesan">Dipesan</option>
      <option value="Dijemput">Dijemput</option>
      <option value="Diproses">Diproses</option>
      <option value="Selesai">Selesai</option>
      <option value="Diantar">Diantar</option>
    </select>
    <button id="refreshBtn" onclick="confirmRefresh()">üîÑ Refresh Orders</button>
    <button id="reportBtn">üìÑ Preview Report</button>
  </div>
  <div id="ordersGrid"></div>
</div>

<!-- MODAL DETAIL ORDER -->
<div id="orderModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3>Detail & Update Order</h3>
    <div id="modalContent"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="modalSaveBtn">üíæ Simpan</button>
      <button id="modalCloseBtn">‚ùå Tutup</button>
    </div>
  </div>
</div>
<!-- MODAL PREVIEW REPORT -->
<div id="reportModal" class="modal" aria-hidden="true">
  <div class="box" style="flex-direction:column;height:90vh">
    <h3>Preview Laporan Orders</h3>
    <div style="flex:1; overflow:auto; border:1px solid #ccc; border-radius:6px">
      <object id="reportPreview" type="application/pdf" width="100%" height="100%"></object>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <select id="reportStatusFilter">
        <option value="">Semua Status</option>
        <option value="Dipesan">Dipesan</option>
        <option value="Dijemput">Dijemput</option>
        <option value="Diproses">Diproses</option>
        <option value="Selesai">Selesai</option>
        <option value="Diantar">Diantar</option>
      </select>
      <button id="applyReportFilter">üîç Filter</button>
      <button id="downloadReportBtn">‚¨áÔ∏è Download PDF</button>
      <button id="closeReportModalBtn">‚ùå Tutup</button>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <p>Sedang memuat data...</p>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyhfdzj1_8VSpMWXSJw5Y1raqUiocwJoSmMSKTidtr0pVnvPdnFseNFbZv5VcUhiAdPcw/exec";
const statusOptions = ["Dipesan","Dijemput","Diproses","Selesai","Diantar"];
let currentData = [];
let seenOrders = new Set(JSON.parse(localStorage.getItem("seenOrders")||"[]"));
let selectedRowIndex = null;

// ======= UTILITY =======
function saveSeenOrders(){ localStorage.setItem("seenOrders", JSON.stringify([...seenOrders])); }
function showNotif(msg, type="success"){ const n=document.getElementById("notif"); n.textContent=msg; n.className="toast "+(type==="success"?"success":"error"); n.style.display="block"; setTimeout(()=>n.style.display="none",3000); }
function showLoading(){ document.getElementById("loadingOverlay").style.display = "flex"; document.getElementById("refreshBtn").disabled = true; }
function hideLoading(){ document.getElementById("loadingOverlay").style.display = "none"; document.getElementById("refreshBtn").disabled = false; }

// ======= LOAD ORDERS =======
function loadOrders(){
  showLoading();
  fetch(GAS_URL, { method:"POST", body: JSON.stringify({ type:"GetAllOrders" }) })
    .then(r=>r.json())
    .then(resp=>{
      const orders = (resp.orders||[]).map((o,i) => ({ ...o, rowIndex: o.rowIndex !== undefined ? o.rowIndex : (i+2) }));
      currentData = orders;
      renderCards(currentData);
      updateDashboard(currentData);
      highlightNewOrders(currentData);
    })
    .catch(err => { console.error(err); showNotif("‚ö†Ô∏è Gagal load order","error"); })
    .finally(()=> hideLoading());
}

// ======= RENDER CARDS =======
function renderCards(data){
  const grid = document.getElementById("ordersGrid");
  grid.innerHTML = "";
  if(!data.length){ grid.innerHTML="<p style='text-align:center;color:#666'>Tidak ada order</p>"; return; }

  const now = new Date();
  data.forEach(o=>{
    const harga = (parseInt(o.Harga)||0).toLocaleString("id-ID");
    const berat = o.Berat || 0;
    let jadwalText = o.Jadwal || "-";
    let jadwalDate = o.Jadwal ? new Date(o.Jadwal) : null;
    if(jadwalDate){
      const pad=n=>n.toString().padStart(2,'0');
      jadwalText = `${pad(jadwalDate.getDate())}/${pad(jadwalDate.getMonth()+1)}/${pad(jadwalDate.getFullYear())} ${pad(jadwalDate.getHours())}:${pad(jadwalDate.getMinutes())}`;
    }
    const card = document.createElement("div");
    card.className = "order-card" + (o.Status==="Diantar"?" diantar":"");
    if(jadwalDate && jadwalDate<now && !["Selesai","Diantar"].includes(o.Status)) card.style.backgroundColor="#fee2e2";

    card.innerHTML = `
      <h4>${escapeHtml(o.Nama||"Tanpa Nama")}</h4>
      <p>üìû ${escapeHtml(o["No HP"]||"-")}</p>
      <p>üìç ${escapeHtml(o.Alamat||"-")}</p>
      <p>üõ† ${escapeHtml(o.Layanan||"-")}</p>
      <p>‚è∞ ${escapeHtml(jadwalText)}</p>
      <p><span class="status ${o.Status}">${o.Status}</span></p>
      <p>‚öñÔ∏è ${berat} Kg | üí∞ Rp ${harga}</p>
      <button onclick="openModalByRow(${o.rowIndex})">Detail / Update</button>
      <button onclick="deleteOrder(${o.rowIndex})" style="background:#dc2626;margin-top:6px">Hapus</button>
    `;
    grid.appendChild(card);
  });
}

// ... lanjutkan script modal detail, filter, dashboard, refresh, delete (sama seperti kode sebelumnya) ...

// ======= PREVIEW REPORT =======
document.getElementById("reportBtn").addEventListener("click",()=>{
  document.getElementById("reportModal").style.display="flex";
  generateReportPreview();
});

document.getElementById("closeReportModalBtn").addEventListener("click",()=>{
  document.getElementById("reportModal").style.display="none";
  const obj = document.getElementById("reportPreview");
  obj.data = "";
});

document.getElementById("applyReportFilter").addEventListener("click", generateReportPreview);

function generateReportPreview(){
  const statusFilter = document.getElementById("reportStatusFilter").value;
  const filtered = statusFilter ? currentData.filter(o=>o.Status===statusFilter) : currentData;
  if(!filtered.length){ showNotif("Tidak ada order untuk preview","error"); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  doc.text("Preview Laporan Orders", 297.5, 30, {align:"center"});
  doc.autoTable({
    head:[["No","Nama","No HP","Layanan","Berat (Kg)","Harga (Rp)","Status","Jadwal"]],
    body: filtered.map((o,i)=>[
      i+1,
      o.Nama||"-",
      o["No HP"]||"-",
      o.Layanan||"-",
      o.Berat||0,
      (parseInt(o.Harga)||0).toLocaleString("id-ID"),
      o.Status||"-",
      o.Jadwal ? new Date(o.Jadwal).toLocaleString("id-ID") : "-"
    ]),
    startY:50
  });

  const pdfBlob = doc.output('blob');
  const pdfUrl = URL.createObjectURL(pdfBlob);
  const obj = document.getElementById("reportPreview");
  obj.data = pdfUrl;
}

document.getElementById("downloadReportBtn").addEventListener("click",()=>{
  const statusFilter = document.getElementById("reportStatusFilter").value;
  const filtered = statusFilter ? currentData.filter(o=>o.Status===statusFilter) : currentData;
  if(!filtered.length){ showNotif("Tidak ada order untuk download","error"); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  doc.text("Laporan Orders", 297.5, 30, {align:"center"});
  doc.autoTable({
    head:[["No","Nama","No HP","Layanan","Berat (Kg)","Harga (Rp)","Status","Jadwal"]],
    body: filtered.map((o,i)=>[
      i+1,
      o.Nama||"-",
      o["No HP"]||"-",
      o.Layanan||"-",
      o.Berat||0,
      (parseInt(o.Harga)||0).toLocaleString("id-ID"),
      o.Status||"-",
      o.Jadwal ? new Date(o.Jadwal).toLocaleString("id-ID") : "-"
    ]),
    startY:50
  });
  const fileName=`Laporan_Orders_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(fileName);
  showNotif("‚úÖ PDF berhasil didownload","success");
});

// ======= INIT =======
window.addEventListener("DOMContentLoaded", loadOrders);
</script>
</body>
</html>
