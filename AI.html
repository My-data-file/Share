<!DOCTYPE html>
<html lang="id">
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AI Memory QC</title>
<style>
/* RESET & BASIC */
* { box-sizing: border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
body {
  font-family:'Segoe UI',system-ui;
  background: linear-gradient(135deg,#1e88e5,#1565c0);
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
a { text-decoration:none; }

/* APP CONTAINER */
.app {
  display:flex;
  flex-direction:column;
  height:100vh;
  backdrop-filter: blur(8px);
}

/* HEADER */
header {
  padding:16px 20px;
  color:white;
  font-weight:600;
  font-size:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  backdrop-filter: blur(10px);
  background: rgba(255,255,255,0.15);
  border-bottom: 1px solid rgba(255,255,255,0.2);
}
header button {
  background: rgba(255,255,255,0.2);
  border:none;
  color:white;
  padding:6px 16px;
  border-radius:20px;
  cursor:pointer;
  transition:0.3s;
}
header button:hover { background: rgba(255,255,255,0.35); }

/* CHAT AREA */
#chat {
  flex:1;
  overflow-y:auto;
  padding:15px 20px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.msg {
  max-width:80%;
  padding:12px 16px;
  border-radius:20px;
  font-size:14px;
  line-height:1.5;
  white-space:pre-wrap;
  word-wrap:break-word;
  box-shadow:0 4px 12px rgba(0,0,0,0.12);
  transition:0.2s;
}

/* USER MESSAGE */
.msg.user {
  align-self:flex-end;
  background:white;
  color:#1565c0;
  border-bottom-right-radius:6px;
  margin-bottom:12px; /* gap di bawah user */
}

/* BOT MESSAGE */
.msg.bot {
  align-self:flex-start;
  background: rgba(255,255,255,0.2);
  color:white;
  border-bottom-left-radius:6px;
  white-space:pre-wrap;
  margin-bottom:20px; /* GAP ANTAR BLOK BOT */
}

/* LABEL DAN VALUE RATA KIRI */
.msg.bot .row {
  display: flex;
  flex-direction: row; /* baris label + value */
  gap: 6px;
  align-items: flex-start;
}
.msg.bot .row span.label {
  font-weight: 600;
  min-width: auto;       /* hilangkan lebar tetap */
  text-align: left;      /* rata kiri */
}
.msg.bot .row span.value {
  flex: 1;
  display: block;
  margin-left: 0;        /* hilangkan margin kiri */
}

/* VALUE TERAKHIR GAP */
.msg.bot .value:last-child {
  margin-bottom:8px; /* jarak setelah nomor terakhir supaya Tanggal berikutnya mudah dibaca */
}

/* DOT ANIMATION */
.dot::after{
  content:''; 
  animation:dots 1.5s infinite;
}
@keyframes dots{
  0%{content:'';}
  33%{content:'.';}
  66%{content:'..';}
  100%{content:'...';}
}

/* INPUT AREA */
.input-area {
  background:white;
  padding:14px 16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  box-shadow:0 -4px 12px rgba(0,0,0,0.1);
}
.input-area select,
.input-area input[type="file"],
.input-area textarea {
  width:100%;
  padding:10px 12px;
  border-radius:20px;
  border:1px solid #ddd;
  font-family:inherit;
  font-size:14px;
}
textarea {
  resize:none;
  min-height:50px;
  max-height:120px;
  overflow-y:auto;
}
.input-row {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
button.action {
  padding:10px 18px;
  border:none;
  border-radius:25px;
  font-weight:600;
  cursor:pointer;
  color:white;
  flex:1;
  min-width:100px;
  transition:0.3s;
}
.save-btn { background:#43a047; }
.save-btn:hover { background:#388e3c; }
.ask-btn { background:#1e88e5; }
.ask-btn:hover { background:#1565c0; }

/* FOOTER */
.footer {
  text-align:center;
  font-size:11px;
  padding:6px;
  background: rgba(255,255,255,0.15);
  color:white;
  border-top:1px solid rgba(255,255,255,0.2);
}

/* RESPONSIVE */
@media (max-width:600px){
  header { font-size:16px; padding:12px 16px; }
  .msg { font-size:13px; }
  .input-area { padding:12px 14px; }
  button.action { flex:1; padding:10px; }
}
</style>
</head>

<body>
<div class="app">

<header>
  AI Memory QC
  <button onclick="clearChat()">Clear</button>
</header>

<div id="chat"></div>

<div class="input-area">
  <select id="user">
    <option value="none">Pilih User</option>
    <option value="QC-Bapro">QC-Bapro</option>
    <option value="QC-Cetak">QC-Cetak</option>
    <option value="QC-Finishing">QC-Finishing</option>
    <option value="QC-Lem">QC-Lem</option>
    <option value="QC-SPV">QC-SPV</option>
    <option value="QC-Manager">QC-Manager</option>
  </select>

  <input type="file" id="file" multiple>

  <div class="input-row">
    <textarea id="text" placeholder="Tulis pertanyaan atau simpan data AI..."></textarea>
  </div>

  <div class="input-row">
    <button class="action save-btn" onclick="save()">üíæ Simpan</button>
    <button class="action ask-btn" onclick="ask()">üöÄ Tanya</button>
  </div>
</div>

<div class="footer">¬© 2026 QC Digital System</div>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbx_KMLHhB9cvA_99Eafm9B6HrOjVs1SmOH6oPGxnJ5AlPy0FJRBwPu-XRrSRhVVYnE3/exec";

const chat=document.getElementById("chat");
const textInput=document.getElementById("text");
const userSelect=document.getElementById("user");
const fileInput=document.getElementById("file");
let isLoading=false;

/* ADD MESSAGE */
function addMsg(text,type,raw=false){
  const div=document.createElement("div");
  div.className="msg "+type;

  if(raw){ 
    div.innerHTML=text; 
  } else {

    const urlRegex=/(https?:\/\/[^\s]+)/g;
    let formatted=text.replace(urlRegex,url=>
      `<a href="${url}" target="_blank" style="color:orange;text-decoration:underline;">${url}</a>`
    );

    const lines = formatted.split("\n");
    let result = [];

    for(let i=0;i<lines.length;i++){

      let line = lines[i].trim();
      if(!line) continue;

      // Jika format:
      // Label :
      // Value
      if(type==="bot" && line.endsWith(":") && lines[i+1]){
        const label = line.replace(":","").trim();
        const value = lines[i+1].trim();
        i++;

        result.push(
          `<div class="row"><span class="label">${label} :</span><span class="value">${value}</span></div>`
        );
        continue;
      }

      // Format normal: Label : Value
      if(type==="bot" && line.includes(":")){
        const index = line.indexOf(":");
        const label = line.substring(0,index).trim();
        const value = line.substring(index+1).trim();

        result.push(
          `<div class="row"><span class="label">${label} :</span><span class="value">${value}</span></div>`
        );
        continue;
      }

      // teks biasa
      result.push(`<div class="value">${line}</div>`);
    }

    div.innerHTML = result.join("");
  }

  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}

/* RESET INPUT */
function resetInput(){ textInput.value=""; fileInput.value=""; }

/* CLEAR CHAT */
function clearChat(){ chat.innerHTML=""; }

/* VALIDATION */
function validate(text){
  if(userSelect.value==="none"){ alert("Pilih user dulu."); return false; }
  if(!text.trim()){ alert("Teks kosong."); return false; }
  return true;
}

/* SAVE */
async function save(){
  if(isLoading) return;
  const text=textInput.value;
  if(!validate(text)) return;

  isLoading=true;
  const loading=addMsg("Menyimpan<span class='dot'></span>","bot",true);

  try{
    const files=fileInput.files;
    let fileArray=[];

    for(let file of files){
      const reader=new FileReader();
      const base64=await new Promise(resolve=>{
        reader.onload=()=>resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(file);
      });
      fileArray.push({ fileName:file.name, mimeType:file.type, fileData:base64 });
    }

    const payload={ action:"add", user:userSelect.value, text:text, files:fileArray };
    const response=await fetch(URL,{ method:"POST", body:new URLSearchParams({ payload:JSON.stringify(payload) }) });
    const result=await response.json();
    loading.remove();

    if(result.status==="success"){ addMsg("‚úÖ Data & file berhasil disimpan","bot"); resetInput(); }
    else{ addMsg("‚ùå "+(result.error||"Gagal menyimpan"),"bot"); }

  }catch(err){
    loading.remove();
    addMsg("‚ùå Server error","bot");
  }
  isLoading=false;
}

/* ASK */
async function ask(){
  if(isLoading) return;
  const text=textInput.value;
  if(!validate(text)) return;

  isLoading=true;
  addMsg(userSelect.value+": "+text,"user");
  textInput.value="";
  const loading=addMsg("Mencari jawaban<span class='dot'></span>","bot",true);

  try{
    const payload={ action:"ask", text:text };
    const response=await fetch(URL,{ method:"POST", body:new URLSearchParams({ payload:JSON.stringify(payload) }) });
    const result=await response.json();
    loading.remove();

    if(result.answer){ addMsg(result.answer,"bot"); }
    else{ addMsg("‚ùå Tidak ada jawaban","bot"); }

  }catch(err){
    loading.remove();
    addMsg("‚ùå Server error","bot");
  }
  isLoading=false;
}
</script>
</body>
</html>
