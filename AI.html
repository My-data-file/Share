<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

body{
  margin:0;
  font-family:'Segoe UI',system-ui;
  background:linear-gradient(135deg,#1e88e5,#1565c0);
  height:100vh;
  display:flex;
  flex-direction:column;
}

.app{
  display:flex;
  flex-direction:column;
  height:100%;
  backdrop-filter: blur(8px);
}

header{
  padding:16px;
  color:white;
  font-weight:600;
  font-size:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header button{
  background:rgba(255,255,255,.2);
  border:none;
  color:white;
  padding:6px 12px;
  border-radius:20px;
  cursor:pointer;
}

#chat{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  max-width:80%;
  padding:12px 16px;
  border-radius:20px;
  font-size:14px;
  line-height:1.5;
  word-wrap:break-word;
  white-space:pre-wrap;
}

.msg a{
  color:#ffeb3b;
  text-decoration:underline;
  word-break:break-all;
  font-weight:600;
}

.msg.user a{
  color:#1565c0;
}

.user{
  align-self:flex-end;
  background:white;
  color:#1565c0;
  border-bottom-right-radius:6px;
}

.bot{
  align-self:flex-start;
  background:rgba(255,255,255,.2);
  color:white;
  border-bottom-left-radius:6px;
}

/* ===== METADATA MONOSPACE ===== */
.meta{
  font-family:Consolas,monospace;
  white-space:pre;
  font-size:13px;
  line-height:1.4;
}

/* ===== INPUT AREA ===== */
.input-area{
  background:white;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
}

select,input[type="file"]{
  padding:10px;
  border-radius:20px;
  border:1px solid #ddd;
  font-size:14px;
}

.file-info{
  font-size:12px;
  color:#666;
  padding-left:6px;
}

.input-row{
  display:flex;
  gap:8px;
}

textarea{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:1px solid #ddd;
  font-size:14px;
  resize:none;
  min-height:40px;
  max-height:120px;
  overflow-y:auto;
  font-family:inherit;
}

button.action{
  padding:10px 16px;
  border:none;
  border-radius:25px;
  font-weight:600;
  cursor:pointer;
  color:white;
}

.save-btn{background:#43a047;}
.ask-btn{background:#1e88e5;}
</style>
</head>

<body>

<div class="app">

<header>
  AI Memory QC
  <button onclick="clearChat()">Clear</button>
</header>

<div id="chat"></div>

<div class="input-area">

<select id="user">
  <option value="none">-- Pilih User --</option>
  <option value="QC-Bapro">QC-Bapro</option>
  <option value="QC-Cetak">QC-Cetak</option>
  <option value="QC-Finishing">QC-Finishing</option>
  <option value="QC-Lem">QC-Lem</option>
  <option value="QC-SPV">QC-SPV</option>
  <option value="QC-Manager">QC-Manager</option>
</select>

<input type="file" id="file" accept="image/*,video/*">
<div id="fileInfo" class="file-info"></div>

<div class="input-row">
  <textarea id="text" placeholder="TULIS PERTANYAAN/SIMPAN DATA AI"></textarea>
</div>

<div class="input-row">
  <button class="action save-btn" onclick="save()">Simpan</button>
  <button class="action ask-btn" onclick="ask()">Tanya</button>
</div>

</div>
</div>

<script>

const URL="https://script.google.com/macros/s/AKfycbyDuKOqTOIJ_-U5ToZrr-GgGF9-A2u5hUn9r96NqIGjkDu3jrz_w7m5PFWkdJnxvEuXWw/exec";

const chat=document.getElementById("chat");
const textInput=document.getElementById("text");
const userSelect=document.getElementById("user");
const fileInput=document.getElementById("file");
const fileInfo=document.getElementById("fileInfo");

let isLoading=false;

/* AUTO RESIZE */
textInput.addEventListener("input",function(){
  this.style.height="auto";
  this.style.height=this.scrollHeight+"px";
});

/* CTRL + ENTER */
textInput.addEventListener("keydown",function(e){
  if(e.key==="Enter" && e.ctrlKey){
    e.preventDefault();
    ask();
  }
});

/* FILE INFO */
fileInput.addEventListener("change",function(){
  const file=this.files[0];
  if(!file){fileInfo.innerText="";return;}

  if(file.size > 5*1024*1024){
    alert("Maksimal file 5MB");
    fileInput.value="";
    return;
  }

  fileInfo.innerText="File: "+file.name+" ("+(file.size/1024/1024).toFixed(2)+" MB)";
});

/* VALIDATION */
function validate(text){
  if(userSelect.value==="none"){alert("Pilih user dulu.");return false;}
  if(!text.trim()){alert("Teks kosong.");return false;}
  return true;
}

/* ESCAPE */
function escapeHTML(str){
  return str.replace(/[&<>"']/g,function(m){
    return ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#039;"
    })[m];
  });
}

/* LINKIFY */
function linkify(text){
  let safeText = escapeHTML(text);
  const urlPattern = /((https?:\/\/|www\.)[^\s]+)/g;

  return safeText.replace(urlPattern,function(url){
    let href = url;
    if(!href.startsWith("http")){
      href = "https://" + href;
    }
    return '<a href="'+href+'" target="_blank">'+url+'</a>';
  });
}

/* ADD MESSAGE (STABLE - SPLIT BY TANGGAL) */
function addMsg(text,type){

  const div=document.createElement("div");
  div.className="msg "+type;

  const cleanText = text.replace(/=+/g,"").trim();

  // Pecah berdasarkan setiap "Tanggal"
  const blocks = cleanText.split(/(?=Tanggal)/g);

  let finalHTML = "";

  blocks.forEach(block=>{

    const lines = block.split("\n").filter(l => l.trim() !== "");
    let metaLines = [];
    let bodyLines = [];

    lines.forEach(line=>{
      const trimmed = line.trim();

      if(
        trimmed.startsWith("Tanggal") ||
        trimmed.startsWith("ID") ||
        trimmed.startsWith("User")
      ){
        metaLines.push(trimmed);
      }else{
        bodyLines.push(trimmed);
      }
    });

    if(metaLines.length >= 2){

      // Metadata
      finalHTML += '<div class="meta">'+linkify(metaLines.join("\n"))+'</div>';

      // Isi langsung di bawah metadata
      if(bodyLines.length){
        finalHTML += '<div style="margin-top:6px">'+linkify(bodyLines.join("\n"))+'</div>';
      }

      // Separator hanya untuk BOT dan bukan loading
      if(type === "bot" && !cleanText.includes("AI sedang berpikir")){
        finalHTML += '<div style="margin:8px 0;font-weight:bold;">================================</div>';
      }

    }else{
      finalHTML += linkify(block);
    }

  });

  div.innerHTML = finalHTML;

  chat.appendChild(div);
  scrollBottom();
  return div;
}

/* SAVE */
async function save(){

  if(isLoading) return;

  const text=textInput.value;
  if(!validate(text)) return;

  isLoading=true;
  const loading=addMsg("Menyimpan...","bot");

  try{

    let fileData=null;
    let fileName=null;
    let mimeType=null;

    const file=fileInput.files[0];

    if(file){
      const reader=new FileReader();
      fileData=await new Promise(resolve=>{
        reader.onload=()=>resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(file);
      });
      fileName=file.name;
      mimeType=file.type;
    }

    const payload={
      action:"add",
      user:userSelect.value,
      text:text,
      fileData:fileData,
      fileName:fileName,
      mimeType:mimeType
    };

    const response=await fetch(URL,{
      method:"POST",
      body:new URLSearchParams({
        payload:JSON.stringify(payload)
      })
    });

    const result=await response.json();
    loading.remove();

    if(result.status==="success"){
      addMsg("✅ Disimpan","bot");
      resetInput();
    }else{
      addMsg("❌ "+(result.error||"Gagal menyimpan"),"bot");
    }

  }catch(err){
    loading.remove();
    addMsg("❌ Server error","bot");
  }

  isLoading=false;
}

/* ASK */
async function ask(){

  if(isLoading) return;

  const text=textInput.value;
  if(!validate(text)) return;

  addMsg(userSelect.value+": "+text,"user");

  isLoading=true;
  const loading=addMsg("AI sedang berpikir...","bot");

  try{

    const payload={
      action:"ask",
      text:text
    };

    const response=await fetch(URL,{
      method:"POST",
      body:new URLSearchParams({
        payload:JSON.stringify(payload)
      })
    });

    const data=await response.json();

    loading.remove();
    addMsg(data.answer||"Tidak ada jawaban.","bot");
    resetInput();

  }catch(err){
    loading.remove();
    addMsg("❌ Server error","bot");
  }

  isLoading=false;
}

/* UTIL */
function resetInput(){
  textInput.value="";
  textInput.style.height="auto";
  fileInput.value="";
  fileInfo.innerText="";
}

function clearChat(){
  if(confirm("Hapus semua chat?")){
    chat.innerHTML="";
  }
}

function scrollBottom(){
  setTimeout(()=>chat.scrollTop=chat.scrollHeight,50);
}

</script>

</body>
</html>
