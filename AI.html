<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;
  font-family:'Segoe UI',system-ui;
  background:linear-gradient(135deg,#1e88e5,#1565c0);
  height:100vh;
  display:flex;
  flex-direction:column;
}
.app{
  display:flex;
  flex-direction:column;
  height:100%;
  backdrop-filter: blur(8px);
}
header{
  padding:16px;
  color:white;
  font-weight:600;
  font-size:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  backdrop-filter: blur(10px);
  background:rgba(255,255,255,0.15);
  border-bottom:1px solid rgba(255,255,255,0.2);
}
header button{
  background:rgba(255,255,255,.2);
  border:none;
  color:white;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
}
#chat{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.msg{
  max-width:80%;
  padding:12px 16px;
  border-radius:20px;
  font-size:14px;
  line-height:1.5;
  white-space:pre-wrap;
  word-wrap:break-word;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
.user{
  align-self:flex-end;
  background:white;
  color:#1565c0;
  border-bottom-right-radius:6px;
}
.bot{
  align-self:flex-start;
  background:rgba(255,255,255,.2);
  color:white;
  border-bottom-left-radius:6px;
}
.dot::after{
  content:''; 
  animation:dots 1.5s infinite;
}
@keyframes dots{
  0%{content:'';}
  33%{content:'.';}
  66%{content:'..';}
  100%{content:'...';}
}
.input-area{
  background:white;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
}
select,input[type="file"]{
  padding:10px;
  border-radius:20px;
  border:1px solid #ddd;
}
textarea{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:1px solid #ddd;
  font-size:14px;
  resize:none;
  min-height:40px;
  max-height:120px;
  overflow-y:auto;
  font-family:inherit;
}
.input-row{
  display:flex;
  gap:8px;
}
button.action{
  padding:10px 18px;
  border:none;
  border-radius:25px;
  font-weight:600;
  cursor:pointer;
  color:white;
}
.save-btn{background:#43a047;}
.ask-btn{background:#1e88e5;}
.footer{
  text-align:center;
  font-size:11px;
  padding:6px;
  background:rgba(255,255,255,0.15);
  color:white;
}
</style>
</head>

<body>

<div class="app">

<header>
  AI Memory QC
  <button onclick="clearChat()">Clear</button>
</header>

<div id="chat"></div>

<div class="input-area">

<select id="user">
  <option value="none">Pilih User</option>
  <option value="QC-Bapro">QC-Bapro</option>
  <option value="QC-Cetak">QC-Cetak</option>
  <option value="QC-Finishing">QC-Finishing</option>
  <option value="QC-Lem">QC-Lem</option>
  <option value="QC-SPV">QC-SPV</option>
  <option value="QC-Manager">QC-Manager</option>
</select>

<input type="file" id="file" multiple>

<div class="input-row">
  <textarea id="text" placeholder="Tulis pertanyaan atau simpan data AI..."></textarea>
</div>

<div class="input-row">
  <button class="action save-btn" onclick="save()">üíæ Simpan</button>
  <button class="action ask-btn" onclick="ask()">üöÄ Tanya</button>
</div>

</div>

<div class="footer">
  ¬© 2026 QC Digital System
</div>

</div>

<script>

const URL="https://script.google.com/macros/s/AKfycbzLuOp30L7No-Nd3vIi-omDpG_fXq2RGBZzB2Tk9_frIjlhCK4WwwJZvpGA5n586lQ7Og/exec";

const chat=document.getElementById("chat");
const textInput=document.getElementById("text");
const userSelect=document.getElementById("user");
const fileInput=document.getElementById("file");

let isLoading=false;

/* ================= ADD MESSAGE ================= */
function addMsg(text,type,raw=false){
  const div=document.createElement("div");
  div.className="msg "+type;

  if(raw){
    div.innerHTML=text;
  }else{
    // Ubah URL jadi clickable link dengan warna oranye
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const linkedText = text.replace(urlRegex, function(url){
      return `<a href="${url}" target="_blank" style="color:orange; text-decoration:underline;">${url}</a>`;
    });
    div.innerHTML = linkedText;
  }

  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}

/* ================= RESET INPUT ================= */
function resetInput(){
  textInput.value="";
  fileInput.value="";
}

/* ================= CLEAR CHAT ================= */
function clearChat(){
  chat.innerHTML="";
}

/* ================= VALIDATION ================= */
function validate(text){
  if(userSelect.value==="none"){alert("Pilih user dulu.");return false;}
  if(!text.trim()){alert("Teks kosong.");return false;}
  return true;
}

/* ================= SAVE ================= */
async function save(){

  if(isLoading) return;

  const text=textInput.value;
  if(!validate(text)) return;

  isLoading=true;
  const loading=addMsg("Menyimpan<span class='dot'></span>","bot",true);

  try{

    const files=fileInput.files;
    let fileArray=[];

    for(let file of files){

      const reader=new FileReader();

      const base64=await new Promise(resolve=>{
        reader.onload=()=>resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(file);
      });

      fileArray.push({
        fileName:file.name,
        mimeType:file.type,
        fileData:base64
      });
    }

    const payload={
      action:"add",
      user:userSelect.value,
      text:text,
      files:fileArray
    };

    const response=await fetch(URL,{
      method:"POST",
      body:new URLSearchParams({
        payload:JSON.stringify(payload)
      })
    });

    const result=await response.json();
    loading.remove();

    if(result.status==="success"){
      addMsg("‚úÖ Data & file berhasil disimpan","bot");
      resetInput();
    }else{
      addMsg("‚ùå "+(result.error||"Gagal menyimpan"),"bot");
    }

  }catch(err){
    loading.remove();
    addMsg("‚ùå Server error","bot");
  }

  isLoading=false;
}

/* ================= ASK ================= */
async function ask(){

  if(isLoading) return;

  const text=textInput.value;
  if(!validate(text)) return;

  isLoading=true;

  addMsg(userSelect.value+": "+text,"user");
  textInput.value="";

  const loading=addMsg("Mencari jawaban<span class='dot'></span>","bot",true);

  try{

    const payload={
      action:"ask",
      text:text
    };

    const response=await fetch(URL,{
      method:"POST",
      body:new URLSearchParams({
        payload:JSON.stringify(payload)
      })
    });

    const result=await response.json();
    loading.remove();

    if(result.answer){
      addMsg(result.answer,"bot");
    }else{
      addMsg("‚ùå Tidak ada jawaban","bot");
    }

  }catch(err){
    loading.remove();
    addMsg("‚ùå Server error","bot");
  }

  isLoading=false;
}

</script>



</body>
</html>
