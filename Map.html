<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplikasi Jemputan Profesional</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { text-align: center; }
form { max-width: 500px; margin: 0 auto; position: relative; }
input, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
textarea { resize: vertical; }
#map { height: 300px; margin-bottom: 10px; border-radius: 8px; position: relative; }
ul.suggestions { list-style: none; padding: 0; margin: 0; border: 1px solid #ccc; max-height: 120px; overflow-y: auto; border-radius: 4px; background: white; position: absolute; z-index: 1000; width: 100%; }
ul.suggestions li { padding: 6px; cursor: pointer; }
ul.suggestions li:hover { background-color: #f0f0f0; }

/* Tombol posisi user */
#btnPosisi {
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: background-color 0.2s;
}
#btnPosisi.loading { background-color: #ffc107; color: #333; cursor: wait; }
#btnPosisi:hover:not(.loading) { background-color: #218838; }

/* Animasi loading kecil */
.spinner {
  border: 2px solid rgba(255,255,255,0.3);
  border-top: 2px solid #fff;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
  display: inline-block;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

/* Tampilkan jarak */
#jarak { font-weight: bold; margin-bottom: 10px; }
</style>
</head>
<body>
<h2>Form Pemesanan Jemputan Profesional</h2>

<form id="formJemput">
  <input type="text" id="nama" placeholder="Nama Pemesan" required>
  <input type="tel" id="hp" placeholder="Nomor HP" required>
  <textarea id="keterangan" placeholder="Keterangan / Jumlah Barang" rows="3"></textarea>

  <input type="text" id="alamat" placeholder="Ketikan alamat jemput..." required>
  <ul id="suggestions" class="suggestions"></ul>

  <button type="button" id="btnPosisi">
    <span class="icon">üìç</span> Gunakan Posisi Saya
  </button>

  <div id="jarak"></div>

  <div id="map"></div>

  <button type="submit" style="background-color:#007bff;color:white;">Pesan Jemputan</button>
</form>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map');
let marker;
const defaultPoint = [-6.166090, 106.703803]; // Bisa ganti titik tujuan default

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

map.setView(defaultPoint, 5);

function placeMarker(latlng) {
  if (marker) marker.setLatLng(latlng);
  else marker = L.marker(latlng).addTo(map);
}

// Reverse geocode
function reverseGeocode(latlng) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&addressdetails=1&accept-language=id`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('alamat').value = data.display_name || '';
      clearSuggestions();
      updateJarak(latlng);
    })
    .catch(() => document.getElementById('alamat').value = '');
}

// Klik peta
map.on('click', function(e) {
  placeMarker(e.latlng);
  reverseGeocode(e.latlng);
});

// Tombol posisi user dengan animasi loading
const btnPosisi = document.getElementById('btnPosisi');
btnPosisi.addEventListener('click', function() {
  if (!navigator.geolocation) { alert("Browser tidak mendukung geolocation."); return; }

  btnPosisi.classList.add('loading');
  btnPosisi.innerHTML = '<span class="spinner"></span> Mencari lokasi‚Ä¶';

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      map.setView([lat, lon], 16);
      placeMarker({lat, lng: lon});
      reverseGeocode({lat, lng: lon});
      btnPosisi.classList.remove('loading');
      btnPosisi.innerHTML = '<span class="icon">üìç</span> Gunakan Posisi Saya';
    },
    () => {
      alert("Tidak dapat mendapatkan lokasi Anda.");
      btnPosisi.classList.remove('loading');
      btnPosisi.innerHTML = '<span class="icon">üìç</span> Gunakan Posisi Saya';
    }
  );
});

// Autocomplete alamat
const input = document.getElementById('alamat');
const suggestions = document.getElementById('suggestions');
input.addEventListener('input', function() {
  const query = this.value;
  if (!query) { clearSuggestions(); return; }

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=ID&accept-language=id`)
    .then(res => res.json())
    .then(data => showSuggestions(data))
    .catch(() => clearSuggestions());
});

function showSuggestions(items) {
  clearSuggestions();
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item.display_name;
    li.addEventListener('click', () => {
      input.value = item.display_name;
      const latlng = [parseFloat(item.lat), parseFloat(item.lon)];
      map.setView(latlng, 16);
      placeMarker(latlng);
      clearSuggestions();
      updateJarak({lat: latlng[0], lng: latlng[1]});
    });
    suggestions.appendChild(li);
  });
}

function clearSuggestions() { suggestions.innerHTML = ''; }

// Hitung jarak (hanya perkiraan) ke default point
function updateJarak(latlng) {
  const R = 6371; // km
  const dLat = toRad(defaultPoint[0]-latlng.lat);
  const dLon = toRad(defaultPoint[1]-latlng.lng);
  const lat1 = toRad(latlng.lat);
  const lat2 = toRad(defaultPoint[0]);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const d = R * c;
  document.getElementById('jarak').textContent = `Jarak ke titik tujuan: ${d.toFixed(2)} km`;
}

function toRad(Value) { return Value*Math.PI/180; }

// Submit form (dummy)
document.getElementById('formJemput').addEventListener('submit', function(e) {
  e.preventDefault();
  const data = {
    nama: document.getElementById('nama').value,
    hp: document.getElementById('hp').value,
    keterangan: document.getElementById('keterangan').value,
    alamat: document.getElementById('alamat').value,
    latlng: marker ? marker.getLatLng() : null
  };
  console.log("Data pemesanan jemputan:", data);
  alert("Pesanan jemputan berhasil dicatat!\nCek console untuk data detail.");
});
</script>
</body>
</html>
