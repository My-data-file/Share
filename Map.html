<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplikasi Jemputan Gratis ‚Äì Leaflet + OSM</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { text-align: center; }
form { max-width: 500px; margin: 0 auto; position: relative; }
input, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
textarea { resize: vertical; }

/* Kolom alamat */
#alamat { 
  background-color: #fff9c4; /* soft kuning */
  color: #333;
  cursor: text;
}
#alamat:focus { outline: none; box-shadow: none; border-color: #ccc; }

/* Kolom jarak */
#jarak {
  background-color: #e0f7fa; /* soft biru muda */
  color: #333;
  cursor: default;
  font-weight: bold;
  border-color: #ccc;
}
#jarak:focus { outline: none; box-shadow: none; border-color: #ccc; }

#map { height: 350px; margin-bottom: 10px; border-radius: 8px; position: relative; }

#btnPosisi { 
  background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; 
  font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s; 
}
#btnPosisi.loading { background-color: #ffc107; color: #333; cursor: wait; }
#btnPosisi:hover:not(.loading) { background-color: #218838; }
.spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<h2>Form Pemesanan Jemputan</h2>

<form id="formJemput">
  <input type="text" id="nama" placeholder="Nama Pemesan" required>
  <input type="tel" id="hp" placeholder="Nomor HP (10‚Äì13 digit)" required pattern="[0-9]{10,13}">
  <textarea id="keterangan" placeholder="Keterangan / Jumlah Barang" rows="3"></textarea>

  <input type="text" id="alamat" placeholder="Alamat otomatis dari GPS" readonly>
  <input type="text" id="jarak" placeholder="Jarak & ETA ke laundry" readonly>

  <button type="button" id="btnPosisi"><span class="icon">üìç</span> Gunakan Posisi Saya</button>
  <button type="button" onclick="document.getElementById('alamat').readOnly=false;">‚úèÔ∏è Masukkan Alamat Manual</button>

  <div id="map"></div>

  <button type="submit" style="background-color:#007bff;color:white;">Pesan Jemputan</button>
</form>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map');
let userMarker, rutePolyline;

// Titik lokasi laundry
const defaultPoint = [-6.200000, 106.816666]; // ganti koordinat laundry
const defaultName = "Laundry Bersih Sejahtera";

// Marker laundry dengan tooltip permanen
L.marker(defaultPoint, {
  icon: L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [30,30]
  })
}).addTo(map)
  .bindTooltip(defaultName, {permanent: true, direction: 'top', offset: [0, -10]})
  .openTooltip();

// Tile OSM publik
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

map.setView(defaultPoint, 12);

// Fungsi menempatkan marker user
function placeUserMarker(latlng) {
  if(userMarker) userMarker.setLatLng(latlng);
  else userMarker = L.marker(latlng, {
    icon: L.icon({
      iconUrl:'https://cdn-icons-png.flaticon.com/512/149/149060.png',
      iconSize:[30,30]
    })
  }).addTo(map)
    .bindTooltip("Posisi Anda", {permanent: true, direction:'top', offset:[0,-10]})
    .openTooltip();
  updateRute(latlng, defaultPoint);
}

// üîß Fungsi update rute via OSRM (jalan tercepat + ETA)
function updateRute(userLatLng, tujuanLatLng){
  if(rutePolyline) map.removeLayer(rutePolyline);

  const url = `https://router.project-osrm.org/route/v1/driving/${userLatLng.lng},${userLatLng.lat};${tujuanLatLng[1]},${tujuanLatLng[0]}?overview=full&geometries=geojson&alternatives=false`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.routes && data.routes.length > 0) {
        const route = data.routes[0];
        const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
        
        rutePolyline = L.polyline(coords, { color: 'blue', weight: 4 }).addTo(map);

        const jarakKm = route.distance / 1000;
        const durasiMenit = Math.round(route.duration / 60); // detik -> menit

        document.getElementById('jarak').value = `Jarak: ${jarakKm.toFixed(2)} km | ETA: ${durasiMenit} menit`;

        map.fitBounds(rutePolyline.getBounds(), { padding: [50, 50] });
      }
    })
    .catch(err => {
      console.error("Gagal memuat rute OSRM:", err);
      const polyline = L.polyline([userLatLng, tujuanLatLng], { color: 'red', dashArray: '5,10' }).addTo(map);
      rutePolyline = polyline;
      document.getElementById('jarak').value = "Tidak dapat hitung rute (fallback ke garis lurus)";
    });
}

// Tombol posisi user
const btnPosisi = document.getElementById('btnPosisi');
let userLatLng = null;
btnPosisi.addEventListener('click', function(){
  if(!navigator.geolocation){ alert("Browser tidak mendukung geolocation."); return; }
  btnPosisi.classList.add('loading');
  btnPosisi.innerHTML = '<span class="spinner"></span> Mencari lokasi‚Ä¶';
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userLatLng = {lat, lng};

      // Reverse geocoding OSM
      fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`, {
        headers: {
          'User-Agent': 'JemputanApp/1.0 (admin@laundry.com)',
          'Accept-Language': 'id'
        }
      })
      .then(res => res.json())
      .then(data => {
        const displayName = data.display_name || "";
        document.getElementById('alamat').value = `${displayName} (Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)})`;
        placeUserMarker(userLatLng); 
      })
      .catch(err => {
        console.error(err);
        document.getElementById('alamat').value = `(Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)})`;
        placeUserMarker(userLatLng);
      });

      btnPosisi.classList.remove('loading');
      btnPosisi.innerHTML = '<span class="icon">üìç</span> Gunakan Posisi Saya';
    },
    ()=>{
      alert("Tidak dapat mendapatkan lokasi Anda.");
      btnPosisi.classList.remove('loading');
      btnPosisi.innerHTML = '<span class="icon">üìç</span> Gunakan Posisi Saya';
    }
  );
});

// Submit form dummy
document.getElementById('formJemput').addEventListener('submit', function(e){
  e.preventDefault();
  const data = {
    nama: document.getElementById('nama').value,
    hp: document.getElementById('hp').value,
    keterangan: document.getElementById('keterangan').value,
    alamat: document.getElementById('alamat').value,
    jarak: document.getElementById('jarak').value,
    userLatLng,
    tujuan: defaultPoint
  };
  console.log("Data pemesanan jemputan:", data);
  alert("Pesanan dicatat! Cek console untuk detail.");
});
</script>

</body>
</html>
