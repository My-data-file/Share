<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplikasi Jemputan Gratis ‚Äì Leaflet + OSM</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { text-align: center; }
form { max-width: 500px; margin: 0 auto; position: relative; }
input, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
textarea { resize: vertical; }

/* Kolom alamat */
#alamat { 
  background-color: #fff9c4; /* soft kuning */
  color: #333;
  cursor: text;
}
#alamat:focus {
  outline: none;
  box-shadow: none;
  border-color: #ccc;
}

/* Kolom jarak */
#jarak {
  background-color: #e0f7fa; /* soft biru muda */
  color: #333;
  cursor: default;
  font-weight: bold;
  border-color: #ccc;
}
#jarak:focus {
  outline: none;
  box-shadow: none;
  border-color: #ccc;
}

#map { height: 350px; margin-bottom: 10px; border-radius: 8px; position: relative; }

#btnPosisi { 
  background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; 
  font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s; 
}
#btnPosisi.loading { background-color: #ffc107; color: #333; cursor: wait; }
#btnPosisi:hover:not(.loading) { background-color: #218838; }
.spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<h2>Form Pemesanan Jemputan V1</h2>

<form id="formJemput">
  <input type="text" id="nama" placeholder="Nama Pemesan" required>
  <input type="tel" id="hp" placeholder="Nomor HP" required>
  <textarea id="keterangan" placeholder="Keterangan / Jumlah Barang" rows="3"></textarea>

  <input type="text" id="alamat" placeholder="" readonly>
  <input type="text" id="jarak" placeholder="" readonly>

  <button type="button" id="btnPosisi"><span class="icon">üìç</span> Gunakan Posisi Saya</button>

  <div id="map"></div>

  <button type="submit" style="background-color:#007bff;color:white;">Pesan Jemputan</button>
</form>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map');
let userMarker, rutePolyline;

// Titik lokasi laundry
const defaultPoint = [-6.200000, 106.816666]; // ganti koordinat laundry
const defaultName = "Laundry Bersih Sejahtera";

// Marker laundry dengan tooltip permanen
L.marker(defaultPoint, {
  icon: L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [30,30]
  })
}).addTo(map)
  .bindTooltip(defaultName, {permanent: true, direction: 'top', offset: [0, -10]})
  .openTooltip();

// Tile OSM publik
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

map.setView(defaultPoint, 12);

// Fungsi menempatkan marker user
function placeUserMarker(latlng) {
  if(userMarker) userMarker.setLatLng(latlng);
  else userMarker = L.marker(latlng, {
    icon: L.icon({
      iconUrl:'https://cdn-icons-png.flaticon.com/512/149/149060.png',
      iconSize:[30,30]
    })
  }).addTo(map)
    .bindTooltip("Posisi Anda", {permanent: true, direction:'top', offset:[0,-10]})
    .openTooltip();
  updateRute(latlng, defaultPoint);
}

// Fungsi update rute garis lurus & jarak
function updateRute(userLatLng, tujuanLatLng){
  if(rutePolyline) map.removeLayer(rutePolyline);
  rutePolyline = L.polyline([userLatLng, tujuanLatLng], {color:'blue', weight:3, dashArray:'5,10'}).addTo(map);
  const jarakKm = haversine(userLatLng, tujuanLatLng);
  document.getElementById('jarak').value = `Jarak ke ${defaultName}: ${jarakKm.toFixed(2)} km`;
}

// Haversine
function haversine(start, end){
  const R = 6371; 
  const dLat = toRad(end[0]-start.lat);
  const dLon = toRad(end[1]-start.lng);
  const lat1 = toRad(start.lat);
  const lat2 = toRad(end[0]);
  const a = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1)*Math.cos(lat2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function toRad(v){return v*Math.PI/180;}

// Tombol posisi user
const btnPosisi = document.getElementById('btnPosisi');
let userLatLng = null;
btnPosisi.addEventListener('click', function(){
  if(!navigator.geolocation){ alert("Browser tidak mendukung geolocation."); return; }
  btnPosisi.classList.add('loading');
  btnPosisi.innerHTML = '<span class="spinner"></span> Mencari lokasi‚Ä¶';
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userLatLng = {lat, lng};
      placeUserMarker(userLatLng);
      map.setView([lat,lng], 14);

      // Reverse geocoding OSM dengan header User-Agent
      fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`, {
        headers: {
          'User-Agent': 'JemputanApp/1.0 (email@domain.com)',
          'Accept-Language': 'id'
        }
      })
      .then(res => res.json())
      .then(data => {
        const displayName = data.display_name || "";
        document.getElementById('alamat').value = `${displayName} (Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)})`;
        updateRute(userLatLng, defaultPoint); // update jarak juga
      })
      .catch(err => {
        console.error(err);
        document.getElementById('alamat').value = `(Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)})`;
        updateRute(userLatLng, defaultPoint);
      });

      btnPosisi.classList.remove('loading');
      btnPosisi.innerHTML = '<span class="icon">üìç</span> Gunakan Posisi Saya';
    },
    ()=>{
      alert("Tidak dapat mendapatkan lokasi Anda.");
      btnPosisi.classList.remove('loading');
      btnPosisi.innerHTML = '<span class="icon">üìç</span> Gunakan Posisi Saya';
    }
  );
});

// Submit form dummy
document.getElementById('formJemput').addEventListener('submit', function(e){
  e.preventDefault();
  const data = {
    nama: document.getElementById('nama').value,
    hp: document.getElementById('hp').value,
    keterangan: document.getElementById('keterangan').value,
    alamat: document.getElementById('alamat').value,
    jarak: document.getElementById('jarak').value,
    userLatLng,
    tujuan: defaultPoint
  };
  console.log("Data pemesanan jemputan:", data);
  alert("Pesanan dicatat! Cek console untuk detail.");
});
</script>

</body>
</html>
